<?php

namespace App\Http\Controllers;

use App\Constants\AreaOptions;
use Illuminate\Http\Request;
use App\Models\PedidoProduccion;
use App\Models\LogoPedido;
use App\Models\LogoCotizacion;
use App\Models\Cotizacion;
use App\Services\CacheCalculosService;
use App\Services\RegistroOrdenExtendedQueryService;
use App\Services\RegistroOrdenSearchExtendedService;
use App\Services\RegistroOrdenFilterExtendedService;
use App\Services\RegistroOrdenTransformService;
use App\Services\RegistroOrdenProcessService;
use App\Services\RegistroOrdenStatsService;
use App\Services\RegistroOrdenProcessesService;
use App\Services\RegistroOrdenEnumService;
use App\Models\Festivo;
use App\Services\FestivosColombiaService;
use Carbon\Carbon;

/**
 * RegistroOrdenQueryController - Query/Search/Filter Layer
 * 
 * Responsabilidad 칰nica: B칰squedas, filtros y consultas de 칩rdenes
 * Cumple: SRP
 * 
 * M칠todos:
 * - index()           - Listar 칩rdenes con paginaci칩n y filtros
 * - show()            - Obtener orden espec칤fica
 * - getNextPedido()   - Obtener siguiente n칰mero de pedido
 * - validatePedido()  - Validar n칰mero de pedido
 */
class RegistroOrdenQueryController extends Controller
{
    use RegistroOrdenExceptionHandler;

    protected $extendedQueryService;
    protected $extendedSearchService;
    protected $extendedFilterService;
    protected $transformService;
    protected $processService;
    protected $statsService;
    protected $processesService;
    protected $enumService;

    public function __construct(
        RegistroOrdenExtendedQueryService $extendedQueryService,
        RegistroOrdenSearchExtendedService $extendedSearchService,
        RegistroOrdenFilterExtendedService $extendedFilterService,
        RegistroOrdenTransformService $transformService,
        RegistroOrdenProcessService $processService,
        RegistroOrdenStatsService $statsService,
        RegistroOrdenProcessesService $processesService,
        RegistroOrdenEnumService $enumService
    )
    {
        $this->extendedQueryService = $extendedQueryService;
        $this->extendedSearchService = $extendedSearchService;
        $this->extendedFilterService = $extendedFilterService;
        $this->transformService = $transformService;
        $this->processService = $processService;
        $this->statsService = $statsService;
        $this->processesService = $processesService;
        $this->enumService = $enumService;
    }

    private function getEnumOptions($table, $column)
    {
        return $this->enumService->getEnumOptions($table, $column);
    }

    /**
     * Listar 칩rdenes con paginaci칩n, b칰squeda y filtros
     * GET /registros
     */
    public function index(Request $request)
    {
        // Handle request for unique values for filters
        if ($request->has('get_unique_values') && $request->has('column')) {
            try {
                $values = $this->extendedQueryService->getUniqueValues($request->input('column'));
                return response()->json(['unique_values' => $values]);
            } catch (\InvalidArgumentException $e) {
                return response()->json(['error' => 'Invalid column'], 400);
            } catch (\Exception $e) {
                return response()->json(['error' => 'Error fetching values: ' . $e->getMessage()], 500);
            }
        }

        $query = $this->extendedQueryService->buildBaseQuery();
        $query = $this->extendedQueryService->applyRoleFilters($query, auth()->user(), $request);
        $query = $this->extendedSearchService->applySearchFilter($query, $request->input('search'));

        // Extraer y aplicar filtros din치micos
        $filterData = $this->extendedFilterService->extractFiltersFromRequest($request);
        $query = $this->extendedFilterService->applyFiltersToQuery($query, $filterData['filters']);
        $filterTotalDias = $filterData['totalDiasFilter'];

        $currentYear = now()->year;
        $nextYear = now()->addYear()->year;
        $festivos = array_merge(
            FestivosColombiaService::obtenerFestivos($currentYear),
            FestivosColombiaService::obtenerFestivos($nextYear)
        );
        
        \Log::info("Antes de verificar filtro - filterTotalDias: " . json_encode($filterTotalDias) . ", es null: " . ($filterTotalDias === null ? 'SI' : 'NO'));
        
        // Si hay filtro de total_de_dias_, necesitamos obtener todos los registros para calcular y filtrar
        if ($filterTotalDias !== null) {
            \Log::info("Iniciando filtrado por total_de_dias_ con valores: " . json_encode($filterTotalDias));
            $todasOrdenes = $query->get();
            \Log::info("Total 칩rdenes obtenidas: " . $todasOrdenes->count());
            
            // Convertir a array para el c치lculo
            $ordenesArray = $todasOrdenes->map(function($orden) {
                return (object) $orden->getAttributes();
            })->toArray();
            
            $totalDiasCalculados = CacheCalculosService::getTotalDiasBatch($ordenesArray, $festivos);
            
            // Filtrar por total_de_dias_
            $ordenesFiltradas = $todasOrdenes->filter(function($orden) use ($totalDiasCalculados, $filterTotalDias) {
                $totalDias = $totalDiasCalculados[$orden->numero_pedido] ?? 0;
                $match = in_array((int)$totalDias, $filterTotalDias, true);
                
                // Log temporal para debug (eliminar despu칠s)
                if ((int)$orden->numero_pedido <= 3) {
                    \Log::info("Filtro total_dias - Pedido: {$orden->numero_pedido}, Total d칤as: {$totalDias}, Filtros: " . json_encode($filterTotalDias) . ", Match: " . ($match ? 'SI' : 'NO'));
                }
                
                return $match;
            });
            
            // Paginar manualmente los resultados filtrados
            $currentPage = request()->get('page', 1);
            $perPage = 25;
            $ordenes = new \Illuminate\Pagination\LengthAwarePaginator(
                $ordenesFiltradas->forPage($currentPage, $perPage)->values(),
                $ordenesFiltradas->count(),
                $perPage,
                $currentPage,
                ['path' => request()->url(), 'query' => request()->query()]
            );
            
            // Recalcular solo para las 칩rdenes de la p치gina actual (con cach칠 inteligente)
            $totalDiasCalculados = CacheCalculosService::getTotalDiasBatch($ordenes->items(), $festivos);
        } else {
            // OPTIMIZACI칍N: Paginaci칩n a 25 items
            $ordenes = $query->paginate(25);
            
            // DEBUG: Log de paginaci칩n
            \Log::info("=== PAGINACI칍N DEBUG ===");
            \Log::info("Total: {$ordenes->total()}");
            \Log::info("P치gina actual: {$ordenes->currentPage()}");
            \Log::info("칔ltima p치gina: {$ordenes->lastPage()}");
            \Log::info("Por p치gina: {$ordenes->perPage()}");
            \Log::info("Tiene b칰squeda: " . ($request->has('search') ? 'S칈' : 'NO'));
            \Log::info("B칰squeda: " . ($request->search ?? 'N/A'));
            \Log::info("HTML paginaci칩n: " . substr($ordenes->links()->toHtml(), 0, 200));

            // OPTIMIZACI칍N CR칈TICA: SOLO calcular para la p치gina actual (25 items) con cach칠
            // No calcular para TODAS las 2257 칩rdenes - usa CacheCalculosService con TTL de 1 hora
            $totalDiasCalculados = CacheCalculosService::getTotalDiasBatch($ordenes->items(), $festivos);
        }

        // Obtener areasMap solo para los items de esta p치gina (OPTIMIZACI칍N)
        $numeroPedidosPagina = array_map(function($orden) {
            return $orden->numero_pedido;
        }, $ordenes->items());
        $areasMap = $this->processService->getLastProcessByOrderNumbers($numeroPedidosPagina);
        
        // Obtener encargados de "Creaci칩n Orden" para cada pedido
        $encargadosCreacionOrdenMap = $this->processService->getCreacionOrdenEncargados($numeroPedidosPagina);

        // Opciones de 치reas disponibles (치reas de procesos)
        $areaOptions = AreaOptions::getArray();
        
        // FALLBACK: Si totalDiasCalculados est치 vac칤o o falta alguna orden, recalcular
        if (empty($totalDiasCalculados)) {
            \Log::warning("totalDiasCalculados vac칤o, recalculando...");
            $totalDiasCalculados = CacheCalculosService::getTotalDiasBatch($ordenes->items(), $festivos);
        } else {
            // Verificar que todas las 칩rdenes tengan un valor
            foreach ($ordenes->items() as $orden) {
                if (!isset($totalDiasCalculados[$orden->numero_pedido])) {
                    \Log::warning("Falta d칤as para pedido {$orden->numero_pedido}, recalculando...");
                    $totalDiasCalculados[$orden->numero_pedido] = 
                        CacheCalculosService::getTotalDias($orden->numero_pedido, $orden->estado);
                }
            }
        }

        if ($request->wantsJson()) {
            // Filtrar campos sensibles seg칰n el rol del usuario
            $ordenesFiltered = array_map(function($orden) use ($areasMap, $encargadosCreacionOrdenMap) {
                return $this->transformService->transformarOrden($orden, $areasMap, $encargadosCreacionOrdenMap);
            }, $ordenes->items());
            
            // Retornar string vac칤o para que paginationManager.js genere el HTML con los estilos correctos
            $paginationHtml = '';
            
            \Log::info("=== PAGINACI칍N ===");
            \Log::info("Total: {$ordenes->total()}");
            \Log::info("칔ltima p치gina: {$ordenes->lastPage()}");
            
            // Determinar contexto y rol para renderizado de botones
            $context = 'registros';
            $userRole = auth()->user() && auth()->user()->role ? auth()->user()->role->name : null;
            
            return response()->json([
                'orders' => $ordenesFiltered,
                'totalDiasCalculados' => $totalDiasCalculados,
                'areaOptions' => $areaOptions,
                'context' => $context,
                'userRole' => $userRole,
                'pagination' => [
                    'current_page' => $ordenes->currentPage(),
                    'last_page' => $ordenes->lastPage(),
                    'per_page' => $ordenes->perPage(),
                    'total' => $ordenes->total(),
                    'from' => $ordenes->firstItem(),
                    'to' => $ordenes->lastItem(),
                ],
                'pagination_html' => $paginationHtml
            ]);
        }

        $context = 'registros';
        $title = 'Registro de 칍rdenes';
        $icon = 'fa-clipboard-list';
        $fetchUrl = '/registros';
        $updateUrl = '/registros';
        $modalContext = 'orden';
        return view('orders.index', compact('ordenes', 'totalDiasCalculados', 'areaOptions', 'areasMap', 'encargadosCreacionOrdenMap', 'context', 'title', 'icon', 'fetchUrl', 'updateUrl', 'modalContext'));
    }

    /**
     * Obtener orden espec칤fica
     * GET /registros/{pedido}
     */
    public function show($pedido)
    {
        // Verificar si la tabla LogoPedido existe antes de consultarla
        try {
            if (!\Schema::hasTable('logo_pedidos')) {
                \Log::warning(' [RegistroOrdenQueryController::show] Tabla logo_pedidos no existe, usando solo PedidoProduccion');
                $logoPedido = null;
            } else {
                // Primero, intentar buscar en LogoPedido
                $logoPedido = \App\Models\LogoPedido::where('numero_pedido', $pedido)->first();
            }
        } catch (\Exception $e) {
            \Log::warning(' [RegistroOrdenQueryController::show] Error verificando tabla logo_pedidos: ' . $e->getMessage());
            $logoPedido = null;
        }
        
        if ($logoPedido) {
            // Es un LogoPedido, devolverlo con toda su informaci칩n
            \Log::info(' [RegistroOrdenQueryController::show] Encontrado LogoPedido', [
                'numero_pedido' => $pedido,
                'pedido_id' => $logoPedido->pedido_id,
                'logo_cotizacion_id' => $logoPedido->logo_cotizacion_id,
            ]);
            
            $logoPedidoArray = $logoPedido->toArray();
            
            // PASO 1: Intentar completar desde PedidoProduccion
            if ($logoPedido->pedido_id) {
                try {
                    $pedidoProd = \App\Models\PedidoProduccion::with('asesora')->find($logoPedido->pedido_id);
                    
                    if ($pedidoProd) {
                        \Log::info(' Encontrado PedidoProduccion, completando datos', [
                            'pedido_id' => $logoPedido->pedido_id,
                            'cliente' => $pedidoProd->cliente,
                            'asesora' => $pedidoProd->asesora?->name,
                            'fecha' => $pedidoProd->fecha_de_creacion_de_orden
                        ]);
                        
                        // Completar desde el pedido de producci칩n - SIEMPRE si viene vac칤o
                        if (empty($logoPedidoArray['cliente']) || $logoPedidoArray['cliente'] === '-') {
                            $logoPedidoArray['cliente'] = $pedidoProd->cliente ?? '-';
                            \Log::info(' [PASO 1] Cliente completado desde PedidoProduccion', ['cliente' => $logoPedidoArray['cliente']]);
                        }
                        if (empty($logoPedidoArray['asesora']) || $logoPedidoArray['asesora'] === '-') {
                            $asesoraName = $pedidoProd->asesora?->name ?? $pedidoProd->asesor?->name ?? '-';
                            $logoPedidoArray['asesora'] = $asesoraName;
                            \Log::info(' [PASO 1] Asesora completada desde PedidoProduccion', ['asesora' => $logoPedidoArray['asesora']]);
                        }
                        if (empty($logoPedidoArray['fecha_de_creacion_de_orden'])) {
                            $logoPedidoArray['fecha_de_creacion_de_orden'] = $pedidoProd->fecha_de_creacion_de_orden;
                            \Log::info(' [PASO 1] Fecha completada desde PedidoProduccion', ['fecha' => $logoPedidoArray['fecha_de_creacion_de_orden']]);
                        }
                        if (empty($logoPedidoArray['descripcion']) && $pedidoProd->descripcion_prendas) {
                            $logoPedidoArray['descripcion'] = $pedidoProd->descripcion_prendas;
                            \Log::info(' [PASO 1] Descripci칩n completada desde PedidoProduccion');
                        }
                    } else {
                        \Log::warning(' [PASO 1] PedidoProduccion no encontrado', ['pedido_id' => $logoPedido->pedido_id]);
                    }
                } catch (\Exception $e) {
                    \Log::error(' [PASO 1] Error al buscar PedidoProduccion', ['error' => $e->getMessage()]);
                }
            }
            
            // PASO 2: Si a칰n falta info, intentar desde LogoCotizacion
            if ($logoPedido->logo_cotizacion_id && (empty($logoPedidoArray['cliente']) || $logoPedidoArray['cliente'] === '-')) {
                try {
                    $logoCot = \App\Models\LogoCotizacion::with('cotizacion')->find($logoPedido->logo_cotizacion_id);
                    
                    if ($logoCot && $logoCot->cotizacion) {
                        \Log::info(' Encontrado LogoCotizacion, completando datos', [
                            'cliente' => $logoCot->cotizacion->cliente,
                            'fecha' => $logoCot->cotizacion->fecha_de_creacion
                        ]);
                        
                        if (empty($logoPedidoArray['cliente']) || $logoPedidoArray['cliente'] === '-') {
                            $logoPedidoArray['cliente'] = $logoCot->cotizacion->cliente ?? '-';
                            \Log::info(' [PASO 2] Cliente completado desde LogoCotizacion', ['cliente' => $logoPedidoArray['cliente']]);
                        }
                        if (empty($logoPedidoArray['fecha_de_creacion_de_orden'])) {
                            $logoPedidoArray['fecha_de_creacion_de_orden'] = $logoCot->cotizacion->fecha_de_creacion;
                            \Log::info(' [PASO 2] Fecha completada desde LogoCotizacion', ['fecha' => $logoPedidoArray['fecha_de_creacion_de_orden']]);
                        }
                        if (empty($logoPedidoArray['asesora']) || $logoPedidoArray['asesora'] === '-') {
                            $logoPedidoArray['asesora'] = $logoCot->cotizacion->asesor?->name ?? '-';
                            \Log::info(' [PASO 2] Asesora completada desde LogoCotizacion', ['asesora' => $logoPedidoArray['asesora']]);
                        }
                        if (empty($logoPedidoArray['descripcion']) && $logoCot->descripcion) {
                            $logoPedidoArray['descripcion'] = $logoCot->descripcion;
                            \Log::info(' [PASO 2] Descripci칩n completada desde LogoCotizacion');
                        }
                    } else {
                        \Log::warning(' [PASO 2] LogoCotizacion no encontrado o sin cotizaci칩n', ['logo_cotizacion_id' => $logoPedido->logo_cotizacion_id]);
                    }
                } catch (\Exception $e) {
                    \Log::error(' [PASO 2] Error al buscar LogoCotizacion', ['error' => $e->getMessage()]);
                }
            }
            
            // PASO 3: Asegurar valores finales
            $logoPedidoArray['numero_pedido'] = $logoPedido->numero_pedido ?? $pedido;
            $logoPedidoArray['cliente'] = $logoPedidoArray['cliente'] ?: '-';
            $logoPedidoArray['asesora'] = $logoPedidoArray['asesora'] ?: '-';
            $logoPedidoArray['descripcion'] = $logoPedido->descripcion ?? '';
            
            //  IMPORTANTE: Si no hay fecha_de_creacion_de_orden, usar created_at
            if (empty($logoPedidoArray['fecha_de_creacion_de_orden'])) {
                $logoPedidoArray['fecha_de_creacion_de_orden'] = $logoPedido->created_at ?? now();
                \Log::info(' [PASO 3] Fecha asignada desde created_at', ['fecha' => $logoPedidoArray['fecha_de_creacion_de_orden']]);
            }
            
            $logoPedidoArray['encargado_orden'] = $logoPedido->encargado_orden ?? '-';
            $logoPedidoArray['forma_de_pago'] = $logoPedido->forma_de_pago ?? '-';
            $logoPedidoArray['observaciones'] = $logoPedido->observaciones ?? '';
            $logoPedidoArray['estado'] = $logoPedido->estado ?? '-';
            $logoPedidoArray['area'] = $logoPedido->area ?? '-';
            $logoPedidoArray['tecnicas'] = $logoPedido->tecnicas ?? [];
            $logoPedidoArray['ubicaciones'] = $logoPedido->ubicaciones ?? [];
            $logoPedidoArray['prendas'] = $logoPedido->prendas ?? [];
            
            // Campos de identificaci칩n
            $logoPedidoArray['es_cotizacion'] = false;
            $logoPedidoArray['es_logo_pedido'] = true;
            
            \Log::info(' [RegistroOrdenQueryController::show] LogoPedido finalizado COMPLETAMENTE', [
                'numero_pedido' => $logoPedidoArray['numero_pedido'],
                'cliente' => $logoPedidoArray['cliente'],
                'asesora' => $logoPedidoArray['asesora'],
                'descripcion' => $logoPedidoArray['descripcion'],
                'fecha_de_creacion_de_orden' => $logoPedidoArray['fecha_de_creacion_de_orden'],
                'forma_de_pago' => $logoPedidoArray['forma_de_pago'],
                'encargado_orden' => $logoPedidoArray['encargado_orden'],
            ]);
            
            return response()->json($logoPedidoArray);
        }
        
        // Si no es LogoPedido, buscar en PedidoProduccion
        $order = PedidoProduccion::with([
            'asesora',
            'cotizacion.tipoCotizacion'
        ])->where('numero_pedido', $pedido)->firstOrFail();

        // Obtener estad칤sticas mediante servicio
        $stats = $this->statsService->getOrderStats($pedido);
        $order->total_cantidad = $stats['total_cantidad'];
        $order->total_entregado = $stats['total_entregado'];

        //  CARGAR prendas CON relaciones ANTES de toArray()
        // Hacemos un query directo para asegurar que las relaciones se cargan
        $prendasConRelaciones = \App\Models\PrendaPedido::where('pedido_produccion_id', $order->id)
            ->with([
                'fotos', 
                'tallas', 
                'procesos.tipoProceso', 
                'procesos.imagenes'
            ])
            ->orderBy('id', 'asc')
            ->get();
        
        \Log::info(' [show] Prendas cargadas con relaciones', [
            'pedido' => $pedido,
            'total' => $prendasConRelaciones->count(),
            'primera_prenda' => $prendasConRelaciones->first() ? [
                'nombre' => $prendasConRelaciones->first()->nombre_prenda,
                'fotos_loaded' => $prendasConRelaciones->first()->relationLoaded('fotos'),
                'tallas_loaded' => $prendasConRelaciones->first()->relationLoaded('tallas'),
                'variantes_loaded' => $prendasConRelaciones->first()->relationLoaded('variantes'),
                'variantes_count' => $prendasConRelaciones->first()->variantes ? $prendasConRelaciones->first()->variantes->count() : 0,
                'procesos_loaded' => $prendasConRelaciones->first()->relationLoaded('procesos')
            ] : 'N/A',
        ]);
        
        // Reemplazar prendas en la orden con las que tienen relaciones
        $order->setRelation('prendas', $prendasConRelaciones);

        //  CONSTRUIR DESCRIPCI칍N MIENTRAS A칔N TENEMOS ACCESO A RELACIONES ELOQUENT
        $descripcionPrendas = $this->buildDescripcionConTallas($order);
        
        \Log::info(' [show] Descripci칩n construida', [
            'longitud' => strlen($descripcionPrendas),
            'primeras_200_caracteres' => substr($descripcionPrendas, 0, 200),
            'contiene_font_size_15' => strpos($descripcionPrendas, 'font-size: 15px') !== false,
            'contiene_important' => strpos($descripcionPrendas, '!important') !== false,
            'HTML_completo' => $descripcionPrendas,
        ]);

        // Filtrar datos sensibles
        $orderArray = $order->toArray();
        
        // Verificar si es una cotizaci칩n
        $esCotizacion = !empty($order->cotizacion_id);
        $orderArray['es_cotizacion'] = $esCotizacion;
        
        // Campos que se ocultan para todos
        $camposOcultosGlobal = ['created_at', 'updated_at', 'deleted_at', 'asesor_id', 'cliente_id'];
        
        // Campos que se ocultan para no-asesores
        $camposOcultosNoAsesor = ['cotizacion_id', 'numero_cotizacion'];
        
        // Agregar nombres en lugar de IDs
        if ($order->asesora) {
            $orderArray['asesor'] = $order->asesora->name ?? '';
            $orderArray['asesora'] = $order->asesora->name ?? '';
        } else {
            $orderArray['asesor'] = '';
            $orderArray['asesora'] = '';
        }
        
        // Para cliente, usar el campo 'cliente' directo (que es el nombre del cliente en la tabla)
        if (!empty($orderArray['cliente_id'])) {
            try {
                $cliente = \App\Models\Cliente::find($orderArray['cliente_id']);
                $orderArray['cliente_nombre'] = $cliente ? $cliente->nombre : ($orderArray['cliente'] ?? '');
            } catch (\Exception $e) {
                $orderArray['cliente_nombre'] = $orderArray['cliente'] ?? '';
            }
        } else {
            $orderArray['cliente_nombre'] = $orderArray['cliente'] ?? '';
        }
        
        // Agregar la descripci칩n ya construida
        $orderArray['descripcion_prendas'] = $descripcionPrendas;
        
        // Obtener prendas formateadas para el modal
        \Log::info(' [getOrderDetails] Obteniendo prendas para pedido', [
            'pedido' => $pedido,
            'es_cotizacion' => $esCotizacion,
        ]);
        
        try {
            // Usar prendas YA cargadas con relaciones
            {
                $prendas = $order->prendas;

                // Helper para normalizar rutas a URL p칰blicas
                $normalize = function ($ruta) {
                    if (empty($ruta)) return null;
                    if (str_starts_with($ruta, 'http')) {
                        return $ruta;
                    }
                    if (str_starts_with($ruta, '/storage/')) {
                        return $ruta;
                    }
                    return '/storage/' . ltrim($ruta, '/');
                };

                // Formatear prendas con todos los datos necesarios
                $prendasFormato = [];
                foreach ($prendas as $index => $prenda) {
                    // Helper para normalizar rutas a URL p칰blicas
                    $normalize = function ($ruta) {
                        if (empty($ruta)) return null;
                        if (str_starts_with($ruta, 'http')) {
                            return $ruta;
                        }
                        if (str_starts_with($ruta, '/storage/')) {
                            return $ruta;
                        }
                        return '/storage/' . ltrim($ruta, '/');
                    };

                    //  NUEVO: Normalizar fotos de prenda (WebP)
                    $fotosNormalizadas = [];
                    if ($prenda->fotos) {
                        foreach ($prenda->fotos as $foto) {
                            $ruta = $foto->ruta_webp ?? $foto->ruta_original;
                            $fotosNormalizadas[] = $normalize($ruta);
                        }
                    }
                    
                    //  NUEVO: Normalizar fotos de tela (WebP) - usando consulta directa
                    $telaFotosNormalizadas = [];
                    try {
                        $fotosTelaDB = \DB::table('prenda_fotos_tela_pedido')
                            ->join('prenda_pedido_colores_telas', 'prenda_fotos_tela_pedido.prenda_pedido_colores_telas_id', '=', 'prenda_pedido_colores_telas.id')
                            ->where('prenda_pedido_colores_telas.prenda_pedido_id', $prenda->id)
                            ->orderBy('prenda_fotos_tela_pedido.orden', 'asc')
                            ->get(['prenda_fotos_tela_pedido.ruta_webp', 'prenda_fotos_tela_pedido.ruta_original']);
                        
                        foreach ($fotosTelaDB as $fotoTela) {
                            $ruta = $fotoTela->ruta_webp ?? $fotoTela->ruta_original;
                            $telaFotosNormalizadas[] = $normalize($ruta);
                        }
                    } catch (\Exception $e) {
                        \Log::warning('Error cargando fotos de tela para prenda ' . $prenda->id . ': ' . $e->getMessage());
                    }
                    
                    $prendasFormato[] = [
                        'id' => $prenda->id,
                        'prenda_pedido_id' => $prenda->id,
                        'numero' => $index + 1,
                        'nombre' => $prenda->nombre_prenda ?? '-',
                        'nombre_prenda' => $prenda->nombre_prenda ?? '-',
                        'descripcion' => $prenda->descripcion ?? '-',
                        'tallas' => $prenda->tallas ? $prenda->tallas->map(function($t) { 
                            return "{$t->talla}:{$t->cantidad}"; 
                        })->implode(', ') : '-',
                        // Los datos de color, tela, etc. ahora vienen de relaciones separadas
                        'fotos' => $fotosNormalizadas,
                        'tela_fotos' => $telaFotosNormalizadas,
                    ];
                }
                
                \Log::info(' [getOrderDetails] Prendas formateadas', [
                    'pedido' => $pedido,
                    'total_prendas' => count($prendasFormato),
                    'primera_prenda' => $prendasFormato[0] ?? null,
                ]);
                
                $orderArray['prendas'] = $prendasFormato;
            }
        } catch (\Exception $e) {
            \Log::warning('Error obteniendo prendas: ' . $e->getMessage());
            $orderArray['prendas'] = [];
        }
        
        // Eliminar campos ocultos globales
        foreach ($camposOcultosGlobal as $campo) {
            unset($orderArray[$campo]);
        }
        
        // Eliminar campos sensibles para no-asesores
        if (!auth()->user() || !auth()->user()->role || auth()->user()->role->name !== 'asesor') {
            foreach ($camposOcultosNoAsesor as $campo) {
                unset($orderArray[$campo]);
            }
        }
        
        return response()->json($orderArray);
    }

    /**
     * Obtener pr칩ximo n칰mero de pedido
     * GET /registros/get-next-pedido
     */
    public function getNextPedido()
    {
        // Este m칠todo ser치 movido a RegistroOrdenController (CRUD)
        // Aqu칤 solo como referencia
        throw new \BadMethodCallException('Use RegistroOrdenController::getNextPedido()');
    }

    /**
     * Validar n칰mero de pedido
     * POST /registros/validate-pedido
     */
    public function validatePedido(Request $request)
    {
        // Este m칠todo ser치 movido a RegistroOrdenController (CRUD)
        // Aqu칤 solo como referencia
        throw new \BadMethodCallException('Use RegistroOrdenController::validatePedido()');
    }

    /**
     * Obtener im치genes de una orden
     * GET /registros/{pedido}/images
     * Par치metro opcional: tipo=logo para obtener solo im치genes de logo
     */
    public function getOrderImages($pedido)
    {
        try {
            $tipo = request()->query('tipo'); // 'logo' o null
            $images = [];

            \Log::info(' [getOrderImages] Iniciando b칰squeda de im치genes', [
                'pedido' => $pedido,
                'tipo' => $tipo
            ]);

            // Obtener desde PedidoProduccion
            $pedidoProduccion = PedidoProduccion::where('numero_pedido', $pedido)->first();
            
            \Log::info(' [getOrderImages] Pedido encontrado', [
                'pedido_id' => $pedidoProduccion?->id,
                'cotizacion_id' => $pedidoProduccion?->cotizacion_id
            ]);

            // Helper para normalizar rutas a URL p칰blicas
            $normalize = function ($ruta) {
                if (empty($ruta)) return null;
                
                // Si ya es una URL completa, devolverla tal cual
                if (str_starts_with($ruta, 'http')) {
                    return $ruta;
                }
                
                // Si ya comienza con /storage/, devolverla tal cual (ya est치 correcta)
                if (str_starts_with($ruta, '/storage/')) {
                    return $ruta;
                }
                
                // Si comienza con storage/ (sin /), agregar / al inicio
                if (str_starts_with($ruta, 'storage/')) {
                    return '/' . $ruta;
                }
                
                // Si es una ruta relativa (ej: pedidos/2695/prendas/...), agregar /storage/
                return '/storage/' . ltrim($ruta, '/');
            };

            // Si el tipo es 'logo', devolver solo im치genes de logo desde logo_pedido_imagenes
            if ($tipo === 'logo') {
                return $this->getLogoImages($pedido, $normalize);
            }

            // 1) Incluir im치genes asociadas a la cotizaci칩n (si existe)
            if ($pedidoProduccion && $pedidoProduccion->cotizacion_id) {
                $cotizacion = Cotizacion::find($pedidoProduccion->cotizacion_id);
                if ($cotizacion && $cotizacion->imagenes) {
                    $cotImages = is_array($cotizacion->imagenes) ? $cotizacion->imagenes : (json_decode($cotizacion->imagenes, true) ?? []);
                    foreach ($cotImages as $ci) {
                        // Soportar formatos: string URL 칩 objeto/array con campo 'url'
                        $raw = null;
                        if (is_string($ci)) {
                            $raw = $ci;
                        } elseif (is_array($ci) && isset($ci['url'])) {
                            $raw = $ci['url'];
                        } elseif (is_object($ci) && isset($ci->url)) {
                            $raw = $ci->url;
                        }

                        $url = $normalize($raw);
                        if ($url) {
                            $images[] = [
                                'url' => $url,
                                'type' => 'cotizacion'
                            ];
                        }
                    }
                }
            }

            // 2) Incluir im치genes guardadas por prenda en el pedido (AGRUPADAS POR PRENDA)
            try {
                $prendas = \DB::table('prendas_pedido')
                    ->where('numero_pedido', $pedido)
                    ->orderBy('id', 'asc')
                    ->get(['id', 'nombre_prenda']);

                \Log::info(' [getOrderImages] Prendas encontradas', [
                    'total_prendas' => $prendas->count()
                ]);

                $prendasConImagenes = [];
                
                foreach ($prendas as $index => $prenda) {
                    $imagenesPrend = [];
                    
                    // Fotos de prenda
                    $fotosPrenda = \DB::table('prenda_fotos_pedido')
                        ->where('prenda_pedido_id', $prenda->id)
                        ->orderBy('orden', 'asc')
                        ->get(['ruta_webp', 'ruta_original', 'ruta_miniatura', 'orden']);

                    \Log::info('[getOrderImages] Fotos de prenda encontradas', [
                        'prenda_id' => $prenda->id,
                        'cantidad' => $fotosPrenda->count()
                    ]);

                    foreach ($fotosPrenda as $fp) {
                        $ruta = $fp->ruta_webp ?? $fp->ruta_original ?? $fp->ruta_miniatura ?? null;
                        \Log::info('[getOrderImages] Foto de prenda - Datos en BD', [
                            'ruta_webp' => $fp->ruta_webp,
                            'ruta_original' => $fp->ruta_original,
                            'ruta_miniatura' => $fp->ruta_miniatura,
                            'ruta_seleccionada' => $ruta
                        ]);
                        $url = $normalize($ruta);
                        if ($url) {
                            $imagenesPrend[] = [
                                'url' => $url,
                                'type' => 'prenda',
                                'orden' => $fp->orden
                            ];
                        }
                    }

                    // Fotos de tela
                    $fotosTela = \DB::table('prenda_fotos_tela_pedido')
                        ->where('prenda_pedido_id', $prenda->id)
                        ->orderBy('orden', 'asc')
                        ->get(['ruta_webp', 'ruta_original', 'ruta_miniatura', 'orden']);

                    \Log::info('[getOrderImages] Fotos de tela encontradas', [
                        'prenda_id' => $prenda->id,
                        'cantidad' => $fotosTela->count()
                    ]);

                    foreach ($fotosTela as $ft) {
                        $ruta = $ft->ruta_webp ?? $ft->ruta_original ?? $ft->ruta_miniatura ?? null;
                        \Log::info('[getOrderImages] Foto de tela - Datos en BD', [
                            'ruta_webp' => $ft->ruta_webp,
                            'ruta_original' => $ft->ruta_original,
                            'ruta_miniatura' => $ft->ruta_miniatura,
                            'ruta_seleccionada' => $ruta
                        ]);
                        $url = $normalize($ruta);
                        if ($url) {
                            $imagenesPrend[] = [
                                'url' => $url,
                                'type' => 'tela',
                                'orden' => $ft->orden
                            ];
                        }
                    }

                    //  SOLO incluir fotos de logo si tipo=logo (ya manejado arriba)
                    // Para el modal de costura, NO incluir fotos de logo
                    // Las fotos de logo se obtienen con tipo=logo en getLogoImages()
                    
                    // Solo agregar prenda si tiene im치genes
                    if (!empty($imagenesPrend)) {
                        $prendasConImagenes[] = [
                            'numero' => $index + 1,
                            'nombre' => $prenda->nombre_prenda,
                            'imagenes' => $imagenesPrend
                        ];
                    }
                }
                
                \Log::info(' [getOrderImages] Prendas con im치genes', [
                    'total_prendas_con_imagenes' => count($prendasConImagenes)
                ]);
                
            } catch (\Exception $inner) {
                \Log::warning('Error al consultar tablas de fotos de prenda: ' . $inner->getMessage(), ['pedido' => $pedido]);
            }

            \Log::info(' [getOrderImages] Resultado final', [
                'total_prendas' => count($prendasConImagenes ?? []),
                'total_images_cotizacion' => count($images)
            ]);

            return response()->json([
                'success' => true,
                'prendas' => $prendasConImagenes ?? [],
                'images_cotizacion' => $images,
                'pedido' => $pedido
            ]);

        } catch (\Exception $e) {
            \Log::error('Error al obtener im치genes de orden: ' . $e->getMessage(), [
                'pedido' => $pedido,
                'error' => $e->getMessage()
            ]);
            return response()->json([
                'success' => false,
                'message' => 'Error al obtener im치genes'
            ], 500);
        }
    }

    /**
     * Obtener descripci칩n de prendas
     * GET /registros/{pedido}/descripcion-prendas
     */
    public function getDescripcionPrendas($pedido)
    {
        try {
            // Buscar la orden por n칰mero de pedido o por ID
            $orden = PedidoProduccion::where('numero_pedido', $pedido)
                ->orWhere('id', $pedido)
                ->first();

            if (!$orden) {
                return response()->json([
                    'success' => false,
                    'message' => 'Orden no encontrada'
                ], 404);
            }

            // Obtener la descripci칩n de prendas del modelo
            // El campo descripcion_prendas contiene la descripci칩n armada
            $descripcionPrendas = $orden->descripcion_prendas ?? '';

            return response()->json([
                'success' => true,
                'descripcion_prendas' => $descripcionPrendas,
                'numero_pedido' => $orden->numero_pedido,
                'orden_id' => $orden->id
            ]);

        } catch (\Exception $e) {
            \Log::error('Error al obtener descripci칩n de prendas: ' . $e->getMessage(), [
                'pedido' => $pedido,
                'error' => $e->getMessage()
            ]);
            return response()->json([
                'success' => false,
                'message' => 'Error al obtener descripci칩n de prendas'
            ], 500);
        }
    }

    /**
     * Calcular d칤as de una orden
     * GET /registros/{pedido}/calcular-dias
     */
    public function calcularDiasAPI(Request $request, $numeroPedido)
    {
        try {
            // Validar entrada
            if (!$numeroPedido) {
                return response()->json(['error' => 'N칰mero de pedido requerido'], 400);
            }

            // Obtener festivos
            $festivos = Festivo::pluck('fecha')->toArray();
            
            // Obtener la orden
            $orden = PedidoProduccion::where('numero_pedido', $numeroPedido)->first();
            if (!$orden) {
                return response()->json(['error' => 'Orden no encontrada'], 404);
            }

            // Calcular d칤as usando el servicio
            $resultado = CacheCalculosService::getTotalDiasBatch([$orden], $festivos);
            $diasCalculados = $resultado[$numeroPedido] ?? 0;

            return response()->json([
                'success' => true,
                'numero_pedido' => $numeroPedido,
                'total_dias' => intval($diasCalculados),
                'timestamp' => now()->toIso8601String()
            ]);
        } catch (\Exception $e) {
            \Log::error('Error en calcularDiasAPI: ' . $e->getMessage());
            return response()->json(['error' => 'Error al calcular d칤as'], 500);
        }
    }

    /**
     * Calcular d칤as de m칰ltiples 칩rdenes
     * POST /registros/calcular-dias-batch
     */
    public function calcularDiasBatchAPI(Request $request)
    {
        try {
            // Validar entrada
            $numeroPedidos = $request->input('numero_pedidos', []);
            if (empty($numeroPedidos)) {
                return response()->json(['error' => 'Lista de pedidos requerida'], 400);
            }

            // Obtener festivos
            $festivos = Festivo::pluck('fecha')->toArray();
            
            // Obtener todas las 칩rdenes
            $ordenes = PedidoProduccion::whereIn('numero_pedido', $numeroPedidos)->get();
            if ($ordenes->isEmpty()) {
                return response()->json(['error' => 'No se encontraron 칩rdenes'], 404);
            }

            // Calcular d칤as para todas
            $resultados = CacheCalculosService::getTotalDiasBatch($ordenes->toArray(), $festivos);

            // Formatear respuesta
            $dias = [];
            foreach ($numeroPedidos as $pedido) {
                $dias[$pedido] = intval($resultados[$pedido] ?? 0);
            }

            return response()->json([
                'success' => true,
                'dias' => $dias,
                'total' => count($dias),
                'timestamp' => now()->toIso8601String()
            ]);
        } catch (\Exception $e) {
            \Log::error('Error en calcularDiasBatchAPI: ' . $e->getMessage());
            return response()->json(['error' => 'Error al calcular d칤as'], 500);
        }
    }

    /**
     * Calcular fecha estimada de entrega
     * POST /api/registros/{id}/calcular-fecha-estimada
     */
    public function calcularFechaEstimada(Request $request, $id)
    {
        try {
            // Validar entrada
            $validated = $request->validate([
                'dia_de_entrega' => 'required|integer|min:1'
            ]);

            // Obtener la orden
            $orden = PedidoProduccion::findOrFail($id);

            if (!$orden->fecha_de_creacion_de_orden) {
                return response()->json([
                    'success' => false,
                    'message' => 'La orden no tiene fecha de creaci칩n'
                ], 400);
            }

            // Asignar temporalmente el d칤a de entrega para calcular
            $orden->dia_de_entrega = $validated['dia_de_entrega'];
            
            // Calcular la fecha estimada
            $fechaEstimada = $orden->calcularFechaEstimada();

            if (!$fechaEstimada) {
                return response()->json([
                    'success' => false,
                    'message' => 'No se pudo calcular la fecha estimada'
                ], 400);
            }

            \Log::info("Fecha estimada calculada para pedido {$orden->numero_pedido}", [
                'dias' => $validated['dia_de_entrega'],
                'fecha_estimada' => $fechaEstimada->format('d/m/Y'),
                'fecha_creacion' => $orden->fecha_de_creacion_de_orden->format('d/m/Y')
            ]);

            return response()->json([
                'success' => true,
                'fecha_estimada' => $fechaEstimada->format('d/m/Y'),
                'fecha_estimada_iso' => $fechaEstimada->toIso8601String(),
                'dias' => $validated['dia_de_entrega'],
                'fecha_creacion' => $orden->fecha_de_creacion_de_orden->format('d/m/Y')
            ]);
        } catch (\Illuminate\Validation\ValidationException $e) {
            return response()->json([
                'success' => false,
                'message' => 'Validaci칩n fallida',
                'errors' => $e->errors()
            ], 422);
        } catch (\Exception $e) {
            \Log::error('Error en calcularFechaEstimada: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Error al calcular la fecha estimada: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Construir descripci칩n con tallas por prenda (l칩gica del blade de asesores)
     * Maneja dos casos: REFLECTIVO y NORMAL
     * 
     * @param PedidoProduccion $order
     * @return string
     */
    private function buildDescripcionConTallas($order)
    {
        $descripcionConTallas = '';
        $descripcionBase = $order->descripcion_prendas ?? '';
        
        \Log::info(' [buildDescripcionConTallas] Descripci칩n recibida:', [
            'pedido' => $order->numero_pedido,
            'longitud' => strlen($descripcionBase),
            'comienza_con' => substr($descripcionBase, 0, 100),
            'es_html' => strpos($descripcionBase, '<span') !== false,
            'contiene_important' => strpos($descripcionBase, '!important') !== false,
            'HTML_completo' => $descripcionBase,
        ]);
        
        //  SI YA TIENE SPANS HTML (descripci칩n generada por Helper), DEVOLVERLA TAL CUAL
        if (strpos($descripcionBase, '<span') !== false) {
            \Log::info(' [buildDescripcionConTallas] Descripci칩n HTML detectada, devolviendo tal cual');
            return $descripcionBase;
        }
        
        // VERIFICAR SI ES COTIZACI칍N TIPO REFLECTIVO
        $esReflectivo = false;
        if ($order->cotizacion && $order->cotizacion->tipoCotizacion) {
            $esReflectivo = ($order->cotizacion->tipoCotizacion->codigo === 'RF');
        }
        
        //  FALLBACK: Si descripci칩n_prendas est치 vac칤a, generar din치micamente desde las prendas
        if (empty($descripcionBase) && $order->prendas && $order->prendas->count() > 0) {
            \Log::info(' [buildDescripcionConTallas] Generando descripci칩n din치micamente', [
                'pedido' => $order->numero_pedido,
                'total_prendas' => $order->prendas->count(),
            ]);
            
            $descripciones = $order->prendas->map(function($prenda, $index) {
                \Log::info('  游빈 [Prenda ' . ($index + 1) . '] Datos disponibles:', [
                    'nombre' => $prenda->nombre_prenda,
                    'color_id' => $prenda->color_id,
                    'color_loaded' => $prenda->relationLoaded('color'),
                    'color_nombre' => $prenda->color ? $prenda->color->nombre : 'NULL',
                    'tela_id' => $prenda->tela_id,
                    'tela_loaded' => $prenda->relationLoaded('tela'),
                    'tela_nombre' => $prenda->tela ? $prenda->tela->nombre : 'NULL',
                    'cantidad_talla' => is_array($prenda->cantidad_talla) ? count($prenda->cantidad_talla) . ' tallas' : 'NULL',
                    'descripcion_variaciones_length' => strlen($prenda->descripcion_variaciones ?? ''),
                ]);
                return $prenda->generarDescripcionDetallada($index + 1);
            })->toArray();
            
            $descripcionBase = implode("\n\n", $descripciones);
            
            \Log::info(' [buildDescripcionConTallas] Descripci칩n generada', [
                'longitud' => strlen($descripcionBase),
                'primeras_lineas' => substr($descripcionBase, 0, 200),
            ]);
        }
        
        if (!empty($descripcionBase) || ($esReflectivo && $order->prendas && $order->prendas->count() > 0)) {
            if ($esReflectivo) {
                // CASO REFLECTIVO: Usar descripci칩n tal cual (ya contiene tallas y cantidad total)
                $descripcionConTallas = '';
                
                \Log::info(' [REFLECTIVO] Construyendo descripci칩n reflectivo', [
                    'pedido' => $order->numero_pedido,
                    'esReflectivo' => $esReflectivo,
                    'total_prendas' => $order->prendas ? $order->prendas->count() : 0,
                ]);
                
                if ($order->prendas && $order->prendas->count() > 0) {
                    foreach ($order->prendas as $index => $prenda) {
                        \Log::info('  游빈 PRENDA ' . ($index + 1), [
                            'nombre' => $prenda->nombre_prenda,
                            'descripcion_length' => strlen($prenda->descripcion ?? ''),
                            'cantidad_talla' => $prenda->cantidad_talla,
                            'tiene_reflectivo' => $prenda->reflectivo ? 'SI' : 'NO',
                        ]);
                        
                        if ($index > 0) {
                            $descripcionConTallas .= "\n\n";
                        }
                        
                        //  NUEVO: Si tiene registro en prendas_reflectivo, usar esa informaci칩n
                        if ($prenda->reflectivo) {
                            $reflectivo = $prenda->reflectivo;
                            
                            // Nombre del producto
                            if (!empty($reflectivo->nombre_producto)) {
                                $descripcionConTallas .= "PRENDA REFLECTIVO: " . strtoupper($reflectivo->nombre_producto);
                            } else {
                                $descripcionConTallas .= "PRENDA REFLECTIVO: " . $prenda->nombre_prenda;
                            }
                            
                            // Descripci칩n
                            if (!empty($reflectivo->descripcion)) {
                                $descripcionConTallas .= "\n" . $reflectivo->descripcion;
                            }
                            
                            // G칠neros
                            if ($reflectivo->generos && is_array($reflectivo->generos)) {
                                $generosStr = implode(', ', array_map('ucfirst', $reflectivo->generos));
                                $descripcionConTallas .= "\nGENEROS: " . $generosStr;
                            }
                            
                            // Tallas por g칠nero (estructura: {genero: {talla: cantidad}})
                            if ($reflectivo->cantidad_talla && is_array($reflectivo->cantidad_talla)) {
                                foreach ($reflectivo->cantidad_talla as $genero => $tallas) {
                                    if (is_array($tallas)) {
                                        $tallasTexto = [];
                                        foreach ($tallas as $talla => $cantidad) {
                                            if ($cantidad > 0) {
                                                $tallasTexto[] = "$talla: $cantidad";
                                            }
                                        }
                                        if (!empty($tallasTexto)) {
                                            $descripcionConTallas .= "\nTALLAS " . strtoupper($genero) . ": " . implode(', ', $tallasTexto);
                                        }
                                    }
                                }
                            }
                            
                            // Ubicaciones
                            if ($reflectivo->ubicaciones && is_array($reflectivo->ubicaciones)) {
                                foreach ($reflectivo->ubicaciones as $ubicacion) {
                                    $ubicDesc = "UBICACION: " . ($ubicacion['nombre'] ?? '');
                                    if (!empty($ubicacion['observaciones'])) {
                                        $ubicDesc .= " - " . $ubicacion['observaciones'];
                                    }
                                    $descripcionConTallas .= "\n" . $ubicDesc;
                                }
                            }
                            
                            // Observaciones generales
                            if (!empty($reflectivo->observaciones_generales)) {
                                $descripcionConTallas .= "\nOBSERVACIONES: " . $reflectivo->observaciones_generales;
                            }
                            
                            \Log::info(' Informaci칩n de REFLECTIVO agregada a descripci칩n', [
                                'nombre_producto' => $reflectivo->nombre_producto,
                                'generos' => $reflectivo->generos,
                                'ubicaciones_count' => count($reflectivo->ubicaciones ?? []),
                            ]);
                        } else {
                            // CASO ANTIGUO: Sin reflectivo, usar descripci칩n normal
                            if (!empty($prenda->descripcion)) {
                                $descripcionConTallas .= $prenda->descripcion;
                            }
                            
                            //  AGREGAR TALLAS SI NO EST츼N EN LA DESCRIPCI칍N
                            if ($prenda->cantidad_talla) {
                                try {
                                    $tallas = is_string($prenda->cantidad_talla) 
                                        ? json_decode($prenda->cantidad_talla, true) 
                                        : $prenda->cantidad_talla;
                                    
                                    if (is_array($tallas) && !empty($tallas)) {
                                        $tallasTexto = [];
                                        foreach ($tallas as $talla => $cantidad) {
                                            if ($cantidad > 0) {
                                                $tallasTexto[] = "$talla: $cantidad";
                                            }
                                        }
                                        if (!empty($tallasTexto)) {
                                            $descripcionConTallas .= "\nTalla: " . implode(', ', $tallasTexto);
                                        }
                                    }
                                } catch (\Exception $e) {
                                    \Log::error('     Error decodificando tallas: ' . $e->getMessage());
                                }
                            }
                        }
                    }
                }
            } else {
                // CASO NORMAL: Parsear por "PRENDA X:"
                if (strpos($descripcionBase, 'PRENDA ') !== false) {
                    $prendas = explode('PRENDA ', $descripcionBase);
                    $prendasCount = 0;
                    
                    foreach ($prendas as $index => $prendaBlock) {
                        if ($index === 0 && empty(trim($prendaBlock))) {
                            continue;
                        }
                        
                        $prendaBlock = trim($prendaBlock);
                        if (empty($prendaBlock)) {
                            continue;
                        }
                        
                        preg_match('/^(\d+):/', $prendaBlock, $matches);
                        $numPrenda = isset($matches[1]) ? intval($matches[1]) : ($prendasCount + 1);
                        
                        $descripcionConTallas .= "PRENDA " . $prendaBlock;
                        
                        if ($order->prendas && $order->prendas->count() > 0) {
                            $prendaActual = $order->prendas->where('numero_prenda', $numPrenda)->first();
                            
                            if (!$prendaActual && $prendasCount < $order->prendas->count()) {
                                $prendaActual = $order->prendas[$prendasCount];
                            }
                            
                            if ($prendaActual && $prendaActual->cantidad_talla) {
                                try {
                                    $tallas = is_string($prendaActual->cantidad_talla) 
                                        ? json_decode($prendaActual->cantidad_talla, true) 
                                        : $prendaActual->cantidad_talla;
                                    
                                    if (is_array($tallas) && !empty($tallas)) {
                                        $tallasTexto = [];
                                        foreach ($tallas as $talla => $cantidad) {
                                            if ($cantidad > 0) {
                                                $tallasTexto[] = "$talla: $cantidad";
                                            }
                                        }
                                        if (!empty($tallasTexto)) {
                                            $descripcionConTallas .= "\nTalla: " . implode(', ', $tallasTexto);
                                        }
                                    }
                                } catch (\Exception $e) {
                                    // Continuar sin tallas
                                }
                            }
                        }
                        
                        $prendasCount++;
                        if ($prendasCount < count($prendas)) {
                            $descripcionConTallas .= "\n\n";
                        }
                    }
                } else {
                    // Descripci칩n sin formato PRENDA
                    $descripcionConTallas = $descripcionBase;
                    
                    if ($order->prendas && $order->prendas->count() > 0) {
                        $prendaActual = $order->prendas->first();
                        
                        if ($prendaActual && $prendaActual->cantidad_talla) {
                            try {
                                $tallas = is_string($prendaActual->cantidad_talla) 
                                    ? json_decode($prendaActual->cantidad_talla, true) 
                                    : $prendaActual->cantidad_talla;
                                
                                if (is_array($tallas) && !empty($tallas)) {
                                    $tallasTexto = [];
                                    foreach ($tallas as $talla => $cantidad) {
                                        if ($cantidad > 0) {
                                            $tallasTexto[] = "$talla: $cantidad";
                                        }
                                    }
                                    if (!empty($tallasTexto)) {
                                        $descripcionConTallas .= "\n\nTallas: " . implode(', ', $tallasTexto);
                                    }
                                }
                            } catch (\Exception $e) {
                                // Continuar sin tallas
                            }
                        }
                    }
                }
            }
        }
        
        if (empty($descripcionConTallas)) {
            $descripcionConTallas = $descripcionBase;
        }
        
        return $descripcionConTallas;
    }

    /**
     * Obtener im치genes de logo desde prenda_fotos_logo_pedido
     * Busca las im치genes asociadas a las prendas del pedido
     */
    private function getLogoImages($pedido, $normalize)
    {
        try {
            \Log::info(' [getLogoImages] Iniciando b칰squeda de im치genes de logo', [
                'numero_pedido' => $pedido
            ]);

            // Normalizar el n칰mero de pedido (agregar # si no lo tiene)
            $pedidoConHash = str_starts_with($pedido, '#') ? $pedido : '#' . $pedido;
            $pedidoSinHash = ltrim($pedido, '#');

            // Buscar logo_pedido por numero_pedido (con o sin #) o por ID
            $logoPedido = \DB::table('logo_pedidos')
                ->where(function($query) use ($pedidoConHash, $pedidoSinHash, $pedido) {
                    $query->where('numero_pedido', $pedidoConHash)
                          ->orWhere('numero_pedido', $pedidoSinHash)
                          ->orWhere('id', $pedido);
                })
                ->first(['id', 'numero_pedido', 'pedido_id', 'cliente', 'asesora', 'forma_de_pago']);

            \Log::info(' [getLogoImages] Logo pedido encontrado', [
                'logo_pedido_id' => $logoPedido?->id,
                'pedido_id' => $logoPedido?->pedido_id,
                'numero_pedido' => $logoPedido?->numero_pedido
            ]);

            $logos = [];
            
            if ($logoPedido && $logoPedido->pedido_id) {
                // Obtener el numero_pedido del pedido_produccion
                $pedidoProduccion = \DB::table('pedidos_produccion')
                    ->where('id', $logoPedido->pedido_id)
                    ->first(['numero_pedido']);
                
                if ($pedidoProduccion) {
                    // Obtener prendas del pedido
                    $prendas = \DB::table('prendas_pedido')
                        ->where('numero_pedido', $pedidoProduccion->numero_pedido)
                        ->get(['id', 'nombre_prenda']);
                    
                    \Log::info(' [getLogoImages] Prendas encontradas', [
                        'total' => $prendas->count()
                    ]);
                    
                    // Obtener im치genes de cada prenda
                    foreach ($prendas as $prenda) {
                        $imagenes = \DB::table('prenda_fotos_logo_pedido')
                            ->where('prenda_pedido_id', $prenda->id)
                            ->orderBy('orden', 'asc')
                            ->get(['ruta_original', 'ruta_webp', 'ubicacion', 'orden', 'ancho', 'alto']);
                        
                        if ($imagenes->count() > 0) {
                            $imagenesFormateadas = [];
                            foreach ($imagenes as $img) {
                                // Priorizar ruta_webp, luego ruta_original
                                $ruta = $img->ruta_webp ?? $img->ruta_original;
                                $url = $normalize($ruta);
                                
                                if ($url) {
                                    $imagenesFormateadas[] = [
                                        'url' => $url,
                                        'nombre' => basename($ruta),
                                        'orden' => $img->orden,
                                        'ancho' => $img->ancho,
                                        'alto' => $img->alto
                                    ];
                                }
                            }
                            
                            if (!empty($imagenesFormateadas)) {
                                $logos[] = [
                                    'id' => $prenda->id,
                                    'titulo' => $prenda->nombre_prenda,
                                    'ubicacion' => $imagenes->first()->ubicacion ?? 'General',
                                    'imagenes' => $imagenesFormateadas
                                ];
                            }
                        }
                    }
                }
            }

            \Log::info(' [getLogoImages] Resultado final', [
                'total_logos' => count($logos),
                'total_imagenes' => collect($logos)->sum(fn($l) => count($l['imagenes'] ?? []))
            ]);

            return response()->json([
                'success' => true,
                'logos' => $logos,
                'pedido' => $pedido,
                'tipo' => 'logo'
            ]);

        } catch (\Exception $e) {
            \Log::error(' [getLogoImages] Error al obtener im치genes de logo: ' . $e->getMessage(), [
                'pedido' => $pedido,
                'trace' => $e->getTraceAsString()
            ]);
            return response()->json([
                'success' => false,
                'message' => 'Error al obtener im치genes de logo',
                'error' => $e->getMessage()
            ], 500);
        }
    }

    /**
     * Obtener LogoPedido por ID con fallback a relacionados
     * @route GET /api/logo-pedidos/{id}
     */
    public function showLogoPedidoById($id)
    {
        try {
            //  Buscar LogoPedido por ID
            $logoPedido = LogoPedido::find($id);
            
            if (!$logoPedido) {
                return response()->json([
                    'error' => 'LogoPedido no encontrado',
                    'id' => $id
                ], 404);
            }

            $logoPedidoArray = $logoPedido->toArray();
            
            \Log::info(' [API] showLogoPedidoById buscando ID: ' . $id, [
                'cliente' => $logoPedidoArray['cliente'] ?? null,
                'asesora' => $logoPedidoArray['asesora'] ?? null,
                'descripcion' => $logoPedidoArray['descripcion'] ?? null,
                'fecha_de_creacion_de_orden' => $logoPedidoArray['fecha_de_creacion_de_orden'] ?? null
            ]);

            //  PASO 1: Completar desde PedidoProduccion si LogoPedido est치 incompleto
            if ($logoPedido->pedido_id && empty($logoPedidoArray['cliente'])) {
                try {
                    $pedidoProduccion = PedidoProduccion::find($logoPedido->pedido_id);
                    if ($pedidoProduccion) {
                        if (empty($logoPedidoArray['cliente'])) {
                            $logoPedidoArray['cliente'] = $pedidoProduccion->cliente;
                        }
                        if (empty($logoPedidoArray['asesora']) && $pedidoProduccion->asesora) {
                            $logoPedidoArray['asesora'] = $pedidoProduccion->asesora->nombre ?? $pedidoProduccion->asesora->name;
                        }
                        if (empty($logoPedidoArray['descripcion'])) {
                            $logoPedidoArray['descripcion'] = $pedidoProduccion->descripcion;
                        }
                        if (empty($logoPedidoArray['fecha_de_creacion_de_orden'])) {
                            $logoPedidoArray['fecha_de_creacion_de_orden'] = $pedidoProduccion->fecha_de_creacion_de_orden;
                        }
                        
                        \Log::info(' [PASO 1 API] Completados datos desde PedidoProduccion #' . $logoPedido->pedido_id);
                    }
                } catch (\Exception $e) {
                    \Log::warning(' [PASO 1 API] Error al obtener PedidoProduccion: ' . $e->getMessage());
                }
            }

            //  PASO 2: Completar desde LogoCotizacion si a칰n hay campos vac칤os
            if ($logoPedido->logo_cotizacion_id && empty($logoPedidoArray['descripcion'])) {
                try {
                    $logoCotizacion = LogoCotizacion::find($logoPedido->logo_cotizacion_id);
                    if ($logoCotizacion) {
                        if (empty($logoPedidoArray['descripcion'])) {
                            $logoPedidoArray['descripcion'] = $logoCotizacion->descripcion;
                        }
                        if (empty($logoPedidoArray['tecnicas'])) {
                            $logoPedidoArray['tecnicas'] = $logoCotizacion->tecnicas;
                        }
                        if (empty($logoPedidoArray['observaciones_tecnicas'])) {
                            $logoPedidoArray['observaciones_tecnicas'] = $logoCotizacion->observaciones_tecnicas;
                        }
                        if (empty($logoPedidoArray['ubicaciones'])) {
                            $logoPedidoArray['ubicaciones'] = $logoCotizacion->ubicaciones;
                        }
                        
                        \Log::info(' [PASO 2 API] Completados datos desde LogoCotizacion #' . $logoPedido->logo_cotizacion_id);
                    }
                } catch (\Exception $e) {
                    \Log::warning(' [PASO 2 API] Error al obtener LogoCotizacion: ' . $e->getMessage());
                }
            }

            //  PASO 3: Garantizar fecha_de_creacion_de_orden usando created_at
            if (empty($logoPedidoArray['fecha_de_creacion_de_orden'])) {
                $logoPedidoArray['fecha_de_creacion_de_orden'] = $logoPedido->created_at;
                \Log::info(' [PASO 3 API] Usando created_at como fecha de creaci칩n');
            }

            //  Responder con datos completos
            \Log::info(' [API] LogoPedido ID ' . $id . ' respondido correctamente', [
                'cliente' => $logoPedidoArray['cliente'],
                'asesora' => $logoPedidoArray['asesora'],
                'descripcion' => $logoPedidoArray['descripcion'],
                'fecha_de_creacion_de_orden' => $logoPedidoArray['fecha_de_creacion_de_orden'],
                'forma_de_pago' => $logoPedidoArray['forma_de_pago'],
                'encargado_orden' => $logoPedidoArray['encargado_orden']
            ]);
            
            return response()->json($logoPedidoArray);
            
        } catch (\Exception $e) {
            \Log::error(' [API] Error en showLogoPedidoById: ' . $e->getMessage(), [
                'id' => $id,
                'trace' => $e->getTraceAsString()
            ]);
            
            return response()->json([
                'error' => 'Error al obtener LogoPedido por ID',
                'id' => $id,
                'message' => $e->getMessage()
            ], 500);
        }
    }

    /**
     * GET /registros/{pedido}/recibos-datos
     * 
     * Obtener datos completos del pedido para el sistema de recibos
     * Delega a PedidoController.obtenerDetalleCompleto() que ya funciona correctamente
     * Compatible con el m칩dulo PedidosRecibosModule
     */
    public function getRecibosDatos($pedido)
    {
        try {
            \Log::info(' [getRecibosDatos] Delegando a PedidoController.obtenerDetalleCompleto', [
                'pedido_numero' => $pedido
            ]);
            
            // Manejo especial para 'sin-numero'
            if ($pedido === 'sin-numero') {
                // Buscar pedidos que no tienen numero_pedido (es nulo o vac칤o)
                $pedidoModel = \App\Models\PedidoProduccion::whereNull('numero_pedido')
                    ->orWhere('numero_pedido', '')
                    ->orderBy('id', 'desc')
                    ->first();
                
                \Log::info(' [getRecibosDatos] Buscando pedido sin n칰mero', [
                    'encontrado' => $pedidoModel ? $pedidoModel->id : null
                ]);
            } else {
                // Si es num칠rico, buscar primero por ID (m치s eficiente)
                if (is_numeric($pedido)) {
                    $pedidoModel = \App\Models\PedidoProduccion::where('id', $pedido)->first();
                    \Log::info(' [getRecibosDatos] Buscando por ID num칠rico', [
                        'id' => $pedido,
                        'encontrado' => $pedidoModel ? true : false
                    ]);
                }
                
                // Si no encuentra por ID, intentar por numero_pedido
                if (!$pedidoModel) {
                    $pedidoModel = \App\Models\PedidoProduccion::where('numero_pedido', $pedido)->first();
                    \Log::info(' [getRecibosDatos] Buscando por numero_pedido', [
                        'numero_pedido' => $pedido,
                        'encontrado' => $pedidoModel ? true : false
                    ]);
                }
            }
            
            if (!$pedidoModel) {
                return response()->json([
                    'error' => 'Pedido no encontrado',
                    'pedido' => $pedido
                ], 404);
            }
            
            $pedidoId = $pedidoModel->id;
            
            \Log::info(' [getRecibosDatos] Pedido encontrado, usando ID', [
                'numero_pedido' => $pedido,
                'pedido_id' => $pedidoId
            ]);
            
            // Resolver PedidoController correctamente desde el contenedor
            $pedidoController = app()->make(\App\Http\Controllers\Api_temp\PedidoController::class);
            
            //  CR칈TICO: Pasar true para filtrar procesos PENDIENTE en /registros
            $response = $pedidoController->obtenerDetalleCompleto($pedidoId, true);
            $responseData = $response->getData(true);
            
            // Extraer datos de la estructura de respuesta
            $datos = $responseData['data'] ?? $responseData;
            
            \Log::info(' [getRecibosDatos] ESTRUCTURA COMPLETA DE RESPUESTA', [
                'numero_pedido' => $pedido,
                'pedido_id' => $pedidoId,
                'datos_completos' => $datos,
                'cliente' => $datos['cliente'] ?? 'N/A',
                'numero_pedido_en_datos' => $datos['numero_pedido'] ?? 'NO ENCONTRADO',
                'numero_en_datos' => $datos['numero'] ?? 'NO ENCONTRADO',
                'total_prendas' => isset($datos['prendas']) ? count($datos['prendas']) : 0
            ]);
            
            \Log::info(' [getRecibosDatos] Datos obtenidos de PedidoController', [
                'numero_pedido' => $pedido,
                'pedido_id' => $pedidoId,
                'cliente' => $datos['cliente'] ?? 'N/A',
                'total_prendas' => isset($datos['prendas']) ? count($datos['prendas']) : 0
            ]);
            
            // PedidoController ya enriquece los datos correctamente
            // Solo retornar la respuesta
            return response()->json($datos);
            
        } catch (\Exception $e) {
            \Log::error(' [getRecibosDatos] Error: ' . $e->getMessage(), [
                'pedido' => $pedido,
                'trace' => $e->getTraceAsString()
            ]);
            
            return response()->json([
                'error' => 'Error al obtener datos de recibos',
                'pedido' => $pedido,
                'message' => $e->getMessage()
            ], 500);
        }
    }
    
    /**
     * Obtener el consecutivo de costura para un pedido
     */
    public function getConsecutivoCostura($pedido)
    {
        try {
            \Log::info(' [getConsecutivoCostura] Obteniendo consecutivo de costura para pedido', ['pedido' => $pedido]);
            
            // Buscar el consecutivo de costura para el pedido
            $consecutivo = \DB::table('consecutivos_recibos_pedidos')
                ->where('pedido_produccion_id', $pedido)
                ->where('tipo_recibo', 'COSTURA')
                ->where('activo', 1)
                ->value('consecutivo_actual');
            
            // Obtener la fecha de creaci칩n del pedido
            $fechaCreacion = \DB::table('pedidos_produccion')
                ->where('id', $pedido)
                ->value('fecha_de_creacion_de_orden');
            
            if ($consecutivo || $fechaCreacion) {
                \Log::info(' [getConsecutivoCostura] Datos encontrados', [
                    'pedido' => $pedido, 
                    'consecutivo' => $consecutivo,
                    'fecha_creacion' => $fechaCreacion
                ]);
                
                return response()->json([
                    'success' => true,
                    'consecutivo' => $consecutivo,
                    'fecha_creacion' => $fechaCreacion
                ]);
            } else {
                \Log::warning(' [getConsecutivoCostura] No se encontraron datos para el pedido', ['pedido' => $pedido]);
                
                return response()->json([
                    'success' => false,
                    'consecutivo' => null,
                    'fecha_creacion' => null,
                    'message' => 'No se encontraron datos para este pedido'
                ]);
            }
            
        } catch (\Exception $e) {
            \Log::error(' [getrecibosCostura] Error al obtener datos del pedido', [
                'pedido' => $pedido,
                'error' => $e->getMessage()
            ]);
            
            return response()->json([
                'success' => false,
                'consecutivo' => null,
                'fecha_creacion' => null,
                'message' => 'Error al obtener datos del pedido'
            ], 500);
        }
    }

    /**
     * Obtener seguimiento por prenda para un pedido
     * GET /registros/{pedido}/seguimiento-prenda
     */
    public function getSeguimientoPorPrenda($pedido)
    {
        try {
            \Log::info('[getSeguimientoPorPrenda] Iniciando consulta', [
                'pedido_numero' => $pedido
            ]);
            
            // Convertir numero_pedido a ID si es necesario
            $pedidoModel = \App\Models\PedidoProduccion::where('numero_pedido', $pedido)->first();
            if (!$pedidoModel) {
                $pedidoModel = \App\Models\PedidoProduccion::where('id', $pedido)->first();
            }
            
            if (!$pedidoModel) {
                return response()->json([
                    'error' => 'Pedido no encontrado',
                    'pedido' => $pedido
                ], 404);
            }
            
            $pedidoId = $pedidoModel->id;
            
            \Log::info('[getSeguimientoPorPrenda] Pedido encontrado', [
                'numero_pedido' => $pedido,
                'pedido_id' => $pedidoId
            ]);
            
            // Obtener prendas del pedido
            $prendas = \App\Models\PrendaPedido::where('pedido_produccion_id', $pedidoId)
                ->with(['variantes', 'procesos.tipoProceso', 'tallas'])
                ->get();
            
            $prendasConSeguimiento = [];
            
            foreach ($prendas as $prenda) {
                // Obtener consecutivos de recibos para esta prenda
                $consecutivos = \App\Models\ConsecutivosRecibosPedidos::where('prenda_id', $prenda->id)
                    ->where('pedido_produccion_id', $pedidoId)
                    ->where('activo', 1)
                    ->get();
                
                // Obtener procesos de seguimiento por 치rea
                $procesosSeguimiento = \App\Models\ProcesoPrenda::where('prenda_pedido_id', $prenda->id)
                    ->where('numero_pedido', $pedidoModel->numero_pedido)  // Usar el n칰mero de pedido correcto
                    ->orderBy('created_at', 'asc')
                    ->get();
                
                // Agrupar consecutivos por tipo de recibo
                $seguimientosPorTipo = [];
                foreach ($consecutivos as $consecutivo) {
                    $seguimientosPorTipo[$consecutivo->tipo_recibo] = [
                        'consecutivo_actual' => $consecutivo->consecutivo_actual,
                        'consecutivo_inicial' => $consecutivo->consecutivo_inicial,
                        'notas' => $consecutivo->notas,
                    ];
                }
                
                // Agrupar procesos por 치rea
                $seguimientosPorArea = [];
                foreach ($procesosSeguimiento as $proceso) {
                    $seguimientosPorArea[$proceso->proceso] = [
                        'id' => $proceso->id,
                        'proceso_prenda_id' => $proceso->prenda_pedido_id,
                        'area' => $proceso->proceso,
                        'estado' => $proceso->estado_proceso,
                        'fecha_inicio' => $proceso->fecha_inicio,
                        'fecha_fin' => $proceso->fecha_fin,
                        'encargado' => $proceso->encargado,
                        'observaciones' => $proceso->observaciones,
                        'codigo_referencia' => $proceso->codigo_referencia,
                        'dias_duracion' => $proceso->dias_duracion,
                        'esta_activo' => $proceso->estado_proceso === 'Pendiente',
                    ];
                }
                
                // Obtener el 치rea y n칰mero de recibo del proceso m치s reciente
                $ultimoProcesoArea = '-';
                $ultimoReciboNumero = '-';
                if (!empty($procesosSeguimiento)) {
                    // Ordenar por fecha de creaci칩n descendente para obtener el m치s reciente
                    $procesosOrdenados = $procesosSeguimiento->sortByDesc('created_at');
                    $ultimoProceso = $procesosOrdenados->first();
                    if ($ultimoProceso) {
                        $ultimoProcesoArea = $ultimoProceso->proceso;
                        
                        // Obtener el n칰mero de recibo m치s reciente para esta prenda
                        \Log::info('[getSeguimientoPorPrenda] Buscando consecutivos para prenda', [
                            'prenda_id' => $prenda->id,
                            'pedido_id' => $pedidoId
                        ]);
                        
                        $consecutivosQuery = \App\Models\ConsecutivosRecibosPedidos::where('prenda_id', $prenda->id)
                            ->where('pedido_produccion_id', $pedidoId)
                            ->where('activo', 1);
                        
                        $consecutivosCount = $consecutivosQuery->count();
                        \Log::info('[getSeguimientoPorPrenda] Consecutivos encontrados', [
                            'prenda_id' => $prenda->id,
                            'pedido_id' => $pedidoId,
                            'total_encontrados' => $consecutivosCount
                        ]);
                        
                        $ultimoRecibo = $consecutivosQuery->orderBy('created_at', 'desc')->first();
                        
                        if ($ultimoRecibo) {
                            $ultimoReciboNumero = $ultimoRecibo->consecutivo_actual;
                            \Log::info('[getSeguimientoPorPrenda] 칔ltimo recibo encontrado', [
                                'prenda_id' => $prenda->id,
                                'consecutivo_actual' => $ultimoRecibo->consecutivo_actual,
                                'tipo_recibo' => $ultimoRecibo->tipo_recibo
                            ]);
                        } else {
                            \Log::warning('[getSeguimientoPorPrenda] No se encontr칩 칰ltimo recibo', [
                                'prenda_id' => $prenda->id,
                                'pedido_id' => $pedidoId
                            ]);
                        }
                    }
                }

                // Construir array de cantidades por talla
                $cantidadTalla = [];
                foreach ($prenda->tallas as $talla) {
                    $cantidadTalla[$talla->talla] = $talla->cantidad;
                }

                // Construir array de procesos para el frontend
                $procesosArray = [];
                foreach ($prenda->procesos as $proceso) {
                    $procesosArray[] = [
                        'id' => $proceso->id,
                        'tipo_proceso_id' => $proceso->tipo_proceso_id,
                        'tipo_proceso' => $proceso->tipoProceso ? [
                            'id' => $proceso->tipoProceso->id,
                            'nombre' => $proceso->tipoProceso->nombre,
                            'slug' => $proceso->tipoProceso->slug,
                            'color' => $proceso->tipoProceso->color,
                            'icono' => $proceso->tipoProceso->icono,
                        ] : null,
                        'estado' => $proceso->estado,
                        'observaciones' => $proceso->observaciones,
                        'ubicaciones' => $proceso->ubicaciones,
                    ];
                }

                $prendasConSeguimiento[] = [
                    'id' => $prenda->id,
                    'nombre_prenda' => $prenda->nombre_prenda,
                    'descripcion' => $prenda->descripcion,
                    'cantidad' => $prenda->cantidad_total,
                    'cantidad_talla' => $cantidadTalla,
                    'de_bodega' => $prenda->de_bodega,
                    'seguimientos' => $seguimientosPorTipo,
                    'seguimientos_por_area' => $seguimientosPorArea,
                    'procesos' => $procesosArray,
                    'consecutivos' => $consecutivos->toArray(), // Agregar consecutivos para el modal
                    'total_procesos' => $prenda->procesos->count(),
                    'total_variantes' => $prenda->variantes->count(),
                    'ultimo_proceso_area' => $ultimoProcesoArea, // 츼rea del proceso m치s reciente
                    'ultimo_recibo_numero' => $ultimoReciboNumero, // N칰mero de recibo m치s reciente
                ];
            }
            
            \Log::info('[getSeguimientoPorPrenda] Datos obtenidos', [
                'numero_pedido' => $pedido,
                'total_prendas' => count($prendasConSeguimiento)
            ]);
            
            return response()->json([
                'pedido' => [
                    'id' => $pedidoModel->id,
                    'numero_pedido' => $pedidoModel->numero_pedido,
                    'cliente' => $pedidoModel->cliente,
                ],
                'prendas' => $prendasConSeguimiento
            ]);
            
        } catch (\Exception $e) {
            \Log::error('[getSeguimientoPorPrenda] Error: ' . $e->getMessage(), [
                'pedido' => $pedido,
                'trace' => $e->getTraceAsString()
            ]);
            
            return response()->json([
                'error' => 'Error al obtener seguimiento por prenda',
                'pedido' => $pedido,
                'message' => $e->getMessage()
            ], 500);
        }
    }
}


