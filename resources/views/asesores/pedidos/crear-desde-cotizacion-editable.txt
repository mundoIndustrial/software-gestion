@extends('layouts.asesores')

@include('components.modal-imagen')

@section('extra_styles')
    <link rel="stylesheet" href="{{ asset('css/crear-pedido.css') }}">
    <link rel="stylesheet" href="{{ asset('css/crear-pedido-editable.css') }}">
    <!-- Componente: Prendas -->
    <link rel="stylesheet" href="{{ asset('css/componentes/prendas.css') }}">
    <!-- Componente: Reflectivo -->
    <link rel="stylesheet" href="{{ asset('css/componentes/reflectivo.css') }}">
@endsection

@section('content')
<!-- Loading Overlay de P√°gina Completa -->
<div id="page-loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Cargando sistema de pedidos...</div>
    <div class="loading-subtext">Por favor espera mientras preparamos todo</div>
</div>

<!-- Header Full Width -->
<div class="page-header">
    <h1>üìã Crear Pedido de Producci√≥n (Editable)</h1>
    <p>Selecciona una cotizaci√≥n y personaliza tu pedido</p>
</div>

<div style="width: 100%; padding: 1.5rem;">
    <form id="formCrearPedidoEditable" class="space-y-6">
        @csrf

        <!-- PASO 1: Informaci√≥n del Pedido -->
        <div class="form-section" id="seccion-info-prenda">
            <h2>
                <span>1</span> Informaci√≥n del Pedido
            </h2>

            <div class="form-row">
                <!-- Campo N√∫mero de Cotizaci√≥n (solo se muestra si viene de cotizaci√≥n) -->
                <div id="campo-numero-cotizacion" class="form-group">
                    <label for="numero_cotizacion_editable">N√∫mero de Cotizaci√≥n</label>
                    <input type="text" id="numero_cotizacion_editable" name="numero_cotizacion" readonly>
                </div>

                <div class="form-group">
                    <label for="cliente_editable">
                        Cliente
                        <span id="cliente-requerido" style="color: #ef4444;">*</span>
                    </label>
                    <input type="text" id="cliente_editable" name="cliente">
                </div>

                <div class="form-group">
                    <label for="asesora_editable">Asesora</label>
                    <input type="text" id="asesora_editable" name="asesora" readonly>
                </div>

                <div class="form-group">
                    <label for="forma_de_pago_editable">Forma de Pago</label>
                    <input type="text" id="forma_de_pago_editable" name="forma_de_pago">
                </div>

                <div class="form-group">
                    <label for="numero_pedido_editable">N√∫mero de Pedido</label>
                    <input type="text" id="numero_pedido_editable" name="numero_pedido" readonly placeholder="Se asignar√° autom√°ticamente" style="background-color: #f3f4f6; cursor: not-allowed;">
                </div>
            </div>
        </div>

        <!-- PASO 2: Seleccionar Cotizaci√≥n -->
        <div class="form-section">
            @php
                $tipoInicial = $tipoInicial ?? 'cotizacion';
                $tituloTipo = match($tipoInicial) {
                    'cotizacion' => 'Pedido desde Cotizaci√≥n',
                    'nuevo' => 'Nuevo Pedido',
                    default => 'Tipo de Pedido'
                };
            @endphp
            
            <h2>
                <span>2</span> {{ $tituloTipo }}
            </h2>

            <!-- Radio Buttons para elegir tipo de pedido (OCULTOS si viene de ruta espec√≠fica) -->
            @if(!isset($tipoInicial) || $tipoInicial === null)
            <div class="form-group" style="margin-bottom: 2rem;">
                <div style="display: flex; gap: 2rem; align-items: center;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 500;">
                        <input type="radio" name="tipo_pedido_editable" id="tipo_desde_cotizacion" value="cotizacion" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span>Desde Cotizaci√≥n</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 500;">
                        <input type="radio" name="tipo_pedido_editable" id="tipo_nuevo_pedido" value="nuevo" style="width: 18px; height: 18px; cursor: pointer;">
                        <span>Nuevo Pedido</span>
                    </label>
                </div>
            </div>
            @else
            <!-- Input hidden para mantener el tipo seleccionado -->
            <input type="hidden" name="tipo_pedido_editable" id="tipo_pedido_hidden" value="{{ $tipoInicial }}">
            <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f0f9ff; border-left: 3px solid #0066cc; border-radius: 4px;">
                <p style="margin: 0; color: #1e40af; font-size: 0.875rem;">
                    <strong>Tipo:</strong> {{ $tituloTipo }}
                </p>
            </div>
            @endif

            <!-- Contenedor para opciones din√°micas -->
            <div id="contenedor-opciones-pedido" style="margin-top: 1.5rem;">
                <!-- Buscador de Cotizaci√≥n (se muestra solo si est√° seleccionado "Desde Cotizaci√≥n") -->
                <div id="seccion-buscar-cotizacion" style="display: block;">
                    <div class="form-group">
                        <label for="cotizacion_search_editable" class="block text-sm font-medium text-gray-700 mb-2">
                            Cotizaci√≥n
                        </label>
                        <div style="position: relative;">
                            <input type="text" id="cotizacion_search_editable" placeholder="üîç Buscar por n√∫mero, cliente o asesora..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" autocomplete="off">
                            <input type="hidden" id="cotizacion_id_editable" name="cotizacion_id">
                            <input type="hidden" id="logoCotizacionId" name="logoCotizacionId">
                            <div id="cotizacion_dropdown_editable" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #d1d5db; border-top: none; border-radius: 0 0 8px 8px; max-height: 300px; overflow-y: auto; display: none; z-index: 1000; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                            </div>
                        </div>
                        <div id="cotizacion_selected_editable" style="margin-top: 0.75rem; padding: 0.75rem; background: #f0f9ff; border-left: 3px solid #0066cc; border-radius: 4px; display: none;">
                            <div style="font-size: 0.875rem; color: #1e40af;"><strong>Seleccionada:</strong> <span id="cotizacion_selected_text_editable"></span></div>
                        </div>
                    </div>
                </div>

                <!-- Selector de Tipo de Pedido (se muestra solo si est√° seleccionado "Nuevo Pedido") -->
                <div id="seccion-tipo-pedido-nuevo" style="display: none;">
                    <div style="display: flex; gap: 1rem; align-items: stretch;">
                        <div class="form-group" style="flex: 1; display: flex; flex-direction: column;">
                            <label for="tipo_pedido_nuevo" class="block text-sm font-medium text-gray-700 mb-2">
                                Tipo de Pedido
                            </label>
                            <!-- Loading State -->
                            <div id="tipo-pedido-loading" style="display: flex; align-items: center; gap: 0.75rem; padding: 1rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px;">
                                <div style="width: 20px; height: 20px; border: 3px solid #e5e7eb; border-top-color: #0066cc; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
                                <span style="color: #6b7280; font-size: 0.875rem;">Cargando opciones...</span>
                            </div>
                            <!-- Select (oculto inicialmente) -->
                            <select id="tipo_pedido_nuevo" name="tipo_pedido_nuevo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="manejarCambiaTipoPedido()" style="display: none;" disabled>
                                <option value="">-- Selecciona un tipo de pedido --</option>
                                <option value="P">PRENDA</option>
                                <option value="R">REFLECTIVO</option>
                                <option value="B">BORDADO</option>
                                <option value="E">ESTAMPADO</option>
                                <option value="EPP">EPP</option>
                            </select>
                        </div>
                        <button type="button" id="btn-agregar-item-tipo-inline" style="display: none; padding: 0.75rem 1.25rem; background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%); color: white; border: none; border-radius: 6px; font-size: 0.9rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.3s; white-space: nowrap; box-shadow: 0 2px 4px rgba(0, 102, 204, 0.2); height: 42px; margin-top: 26px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0, 102, 204, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0, 102, 204, 0.2)'">
                            <span class="material-symbols-rounded" style="font-size: 1.25rem;">add_circle</span>
                            Agregar
                        </button>
                    </div>
                </div>
                
                <!-- CSS para la animaci√≥n del spinner -->
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            </div>
        </div>

        <!-- PASO 3: √çtems del Pedido -->
        <div class="form-section" id="seccion-items-pedido" style="margin-top: 2rem;">
            <h2>
                <span>3</span> √çtems del Pedido
            </h2>

            <!-- Lista de √≠tems -->
            <div id="lista-items-pedido" style="display: flex; flex-direction: column; gap: 0.75rem;">
                <!-- Los √≠tems se agregar√°n aqu√≠ din√°micamente -->
            </div>

            <!-- Mensaje cuando no hay √≠tems -->
            <div id="mensaje-sin-items" style="padding: 2rem; text-align: center; background: #f9fafb; border: 2px dashed #d1d5db; border-radius: 8px; color: #6b7280;">
                <p style="margin: 0; font-size: 0.875rem;">No hay √≠tems agregados. Selecciona un tipo de pedido para agregar nuevos √≠tems.</p>
            </div>
        </div>

        <!-- COMPONENTE: Prendas Editables -->
        @include('asesores.pedidos.components.prendas-editable')

        <!-- COMPONENTE: Reflectivo Editable -->
        @include('asesores.pedidos.components.reflectivo-editable')

        <!-- PASO 6: Botones de Acci√≥n -->
        <div class="btn-actions">
            <button type="button" id="btn-vista-previa" class="btn btn-secondary" style="display: none; background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.3s; box-shadow: 0 2px 4px rgba(107, 114, 128, 0.2); display: flex; align-items: center; gap: 0.5rem;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(107, 114, 128, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(107, 114, 128, 0.2)'" title="Ver factura en tama√±o grande">
                <span class="material-symbols-rounded" style="font-size: 1.1rem;">visibility</span>
                Vista Previa
            </button>
            <button type="submit" id="btn-submit" class="btn btn-primary" style="display: none; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.3s; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2); display: flex; align-items: center; justify-content: center; gap: 0.5rem;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(59, 130, 246, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(59, 130, 246, 0.2)'">
                <span class="material-symbols-rounded" style="font-size: 1.1rem;">check_circle</span>
                Crear Pedido
            </button>
            <a href="{{ route('asesores.pedidos-produccion.index') }}" class="btn btn-secondary">
                ‚úï Cancelar
            </a>
        </div>
    </form>
</div>

@include('asesores.pedidos.modals.modal-seleccionar-prendas')

@include('asesores.pedidos.modals.modal-seleccionar-tallas')

@include('asesores.pedidos.modals.modal-agregar-prenda-nueva')

@include('asesores.pedidos.modals.modal-agregar-reflectivo')

@endsection

@push('scripts')
    <!-- IMPORTANTE: Cargar constantes PRIMERO -->
    <script src="{{ asset('js/constantes-tallas.js') }}"></script>
    
    <!-- IMPORTANTE: Cargar m√≥dulos DESPU√âS de las constantes -->
    <script src="{{ asset('js/modulos/crear-pedido/modales-dinamicos.js') }}"></script>
    <script src="{{ asset('js/modulos/crear-pedido/gestion-tallas.js') }}"></script>
    <script src="{{ asset('js/modulos/crear-pedido/gestion-telas.js') }}"></script>
    <script src="{{ asset('js/modulos/crear-pedido/gestion-items-pedido.js') }}"></script>
    <script src="{{ asset('js/modulos/crear-pedido/modal-seleccion-prendas.js') }}"></script>
    
    <!-- Componente: Prendas -->
    <script src="{{ asset('js/componentes/prendas.js') }}"></script>
    
    <!-- Componente: Reflectivo -->
    <script src="{{ asset('js/componentes/reflectivo.js') }}"></script>
    
    <!-- Datos del servidor (transformados en el Controller) -->
    <script>
        window.cotizacionesData = @json($cotizacionesData ?? []);
        window.asesorActualNombre = '{{ Auth::user()->name ?? '' }}';
        
        // Mostrar la secci√≥n de √≠tems al cargar
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar storages de im√°genes
            window.imagenesPrendaStorage = new ImageStorageService(3);
            window.imagenesTelaStorage = new ImageStorageService(3);
            window.imagenesReflectivoStorage = new ImageStorageService(3);
            
            const seccionItems = document.getElementById('seccion-items-pedido');
            if (seccionItems) {
                seccionItems.style.display = 'block';
            }
            console.log('‚úÖ Secci√≥n de √≠tems mostrada');
            console.log('üìã Cotizaciones disponibles:', window.cotizacionesData.length);
            console.log('‚úÖ Storages de im√°genes inicializados');
        });
    </script>
    <!-- Cargar m√≥dulos de gesti√≥n de pedidos (DDD - L√≥gica en backend) -->
    <script src="{{ asset('js/modulos/crear-pedido/api-pedidos-editable.js') }}"></script>
    <script src="{{ asset('js/modulos/crear-pedido/image-storage-service.js') }}"></script>
    <script src="{{ asset('js/modulos/crear-pedido/gestion-items-pedido-refactorizado.js') }}"></script>

    <script>
        // Legacy: Mantener compatibilidad con funciones de galer√≠as de im√°genes
        // TODO: Refactorizar estas funciones a m√≥dulos separados
        
        // Funciones de manejo de im√°genes delegadas a image-storage-service.js
        // Mantener compatibilidad con handlers de input
        function manejarImagenesTela(input) {
            if (!input.files || input.files.length === 0) {
                return;
            }
            
            window.imagenesTelaStorage.agregarImagen(input.files[0])
                .then(() => {
                    actualizarPreviewTela();
                })
                .catch(err => {
                    alert(err.message);
                });
            input.value = '';
        }
        
        function actualizarPreviewTela() {
            const imagenes = window.imagenesTelaStorage.obtenerImagenes();
            
            // Encontrar la celda de imagen en la fila de inputs
            const tbody = document.getElementById('tbody-telas');
            const primeraFila = tbody.querySelector('tr');
            if (!primeraFila) return;
            
            const celdaImagen = primeraFila.querySelector('td:nth-child(4)');
            if (!celdaImagen) return;
            
            // Limpiar previews anteriores
            const previousPreview = celdaImagen.querySelector('.imagen-preview-tela-temp');
            if (previousPreview) {
                previousPreview.remove();
            }
            
            if (imagenes.length === 0) return;
            
            // Crear contenedor para las im√°genes
            const previewDiv = document.createElement('div');
            previewDiv.className = 'imagen-preview-tela-temp';
            previewDiv.style.cssText = 'display: flex; gap: 0.5rem; align-items: center; margin-top: 0.5rem; flex-wrap: wrap;';
            
            // Mostrar todas las im√°genes agregadas
            imagenes.forEach((img, index) => {
                const imgElement = document.createElement('img');
                imgElement.src = img.data;
                imgElement.style.cssText = 'width: 50px; height: 50px; border-radius: 4px; object-fit: cover; border: 2px solid #0066cc; cursor: pointer;';
                imgElement.title = `Imagen ${index + 1}`;
                imgElement.onclick = () => mostrarGaleriaImagenes(imagenes, index);
                previewDiv.appendChild(imgElement);
            });
            
            celdaImagen.appendChild(previewDiv);
        }
        
        // ‚ö†Ô∏è FUNCIONES DE PRENDAS MOVIDAS AL COMPONENTE
        // Las siguientes funciones se encuentran en: public/js/componentes/prendas.js
        // - manejarImagenesPrenda(input)
        // - actualizarPreviewPrenda()
        // - abrirGaleriaOSelectorPrenda()
        





        
        // ========== INICIALIZACI√ìN DE BOTONES DE G√âNEROS ==========
        // Configuraci√≥n inicial
        document.addEventListener('DOMContentLoaded', function() {
            // Registrar event listeners para botones de g√©nero despu√©s de que gestion-tallas.js est√© cargado
            const btnDama = document.getElementById('btn-genero-dama');
            const btnCaballero = document.getElementById('btn-genero-caballero');
            
            if (btnDama && typeof abrirModalSeleccionarTallas === 'function') {
                btnDama.onclick = function() {
                    abrirModalSeleccionarTallas('dama');
                };
            }
            
            if (btnCaballero && typeof abrirModalSeleccionarTallas === 'function') {
                btnCaballero.onclick = function() {
                    abrirModalSeleccionarTallas('caballero');
                };
            }
            
            // ========== BUSCADOR DE COTIZACIONES ==========

            const searchInput = document.getElementById('cotizacion_search_editable');
            const dropdown = document.getElementById('cotizacion_dropdown_editable');
            const selectedDiv = document.getElementById('cotizacion_selected_editable');
            const selectedText = document.getElementById('cotizacion_selected_text_editable');
            const hiddenInput = document.getElementById('cotizacion_id_editable');
            
            console.log('üîç [BUSCADOR] Elementos encontrados:', {
                searchInput: !!searchInput,
                dropdown: !!dropdown,
                selectedDiv: !!selectedDiv,
                selectedText: !!selectedText,
                hiddenInput: !!hiddenInput
            });
            
            if (!searchInput) {
                console.error('‚ùå [BUSCADOR] No se encontr√≥ el input de b√∫squeda');
                return;
            }
            
            let cotizacionSeleccionada = null;
            
            // Mostrar todas las cotizaciones al hacer focus
            searchInput.addEventListener('focus', function() {
                console.log('üîç [BUSCADOR] Focus en el campo de b√∫squeda');
                mostrarCotizaciones('');
            });
            
            // Filtrar cotizaciones al escribir
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                console.log('üîç [BUSCADOR] B√∫squeda:', searchTerm);
                mostrarCotizaciones(searchTerm);
            });
            
            // Funci√≥n para mostrar cotizaciones filtradas
            function mostrarCotizaciones(searchTerm) {
                if (searchTerm.length === 0) {
                    // Mostrar todas las cotizaciones
                    renderizarDropdown(window.cotizacionesData);
                    return;
                }
                
                const filtered = window.cotizacionesData.filter(cot => {
                    return cot.numero_cotizacion.toLowerCase().includes(searchTerm) ||
                           cot.cliente.toLowerCase().includes(searchTerm) ||
                           cot.asesora.toLowerCase().includes(searchTerm);
                });
                
                renderizarDropdown(filtered);
            }
            
            // Funci√≥n para renderizar el dropdown
            function renderizarDropdown(cotizaciones) {
                console.log('üîç [BUSCADOR] Renderizando dropdown con', cotizaciones.length, 'cotizaciones');
                
                if (cotizaciones.length === 0) {
                    dropdown.innerHTML = '<div style="padding: 1rem; text-align: center; color: #6b7280;">No se encontraron cotizaciones</div>';
                    dropdown.style.display = 'block';
                    console.log('üîç [BUSCADOR] Mostrando mensaje de "no encontrado"');
                    return;
                }
                
                dropdown.innerHTML = cotizaciones.map(cot => `
                    <div class="cotizacion-item" data-id="${cot.id}" style="padding: 0.75rem; cursor: pointer; border-bottom: 1px solid #e5e7eb; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
                        <div style="font-weight: 600; color: #1e40af;">${cot.numero_cotizacion}</div>
                        <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                            Cliente: ${cot.cliente} | Asesora: ${cot.asesora}
                        </div>
                    </div>
                `).join('');
                
                dropdown.style.display = 'block';
                console.log('‚úÖ [BUSCADOR] Dropdown mostrado con', cotizaciones.length, 'resultados');
                
                // Agregar event listeners a los items
                dropdown.querySelectorAll('.cotizacion-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const cotId = parseInt(this.dataset.id);
                        const cotizacion = window.cotizacionesData.find(c => c.id === cotId);
                        seleccionarCotizacion(cotizacion);
                    });
                });
            }
            
            // Funci√≥n para seleccionar cotizaci√≥n
            function seleccionarCotizacion(cotizacion) {
                cotizacionSeleccionada = cotizacion;
                hiddenInput.value = cotizacion.id;
                searchInput.value = cotizacion.numero_cotizacion;
                selectedText.textContent = `${cotizacion.numero_cotizacion} - ${cotizacion.cliente}`;
                selectedDiv.style.display = 'block';
                dropdown.style.display = 'none';
                
                console.log('‚úÖ Cotizaci√≥n seleccionada:', cotizacion);
                
                // Abrir modal de selecci√≥n de prendas
                if (typeof window.abrirModalSeleccionPrendas === 'function') {
                    window.abrirModalSeleccionPrendas(cotizacion);
                } else {
                    console.error('‚ùå Funci√≥n abrirModalSeleccionPrendas no est√° disponible');
                }
            }
            
            // Cerrar dropdown al hacer click fuera
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
            
            // ========== RESTO DE LA CONFIGURACI√ìN ==========
            // Configurar asesora
            document.getElementById('asesora_editable').value = '{{ Auth::user()->name ?? '' }}';
            
            // Mostrar botones
            const btnSubmit = document.getElementById('btn-submit');
            btnSubmit.textContent = '‚úì Crear Pedido';
            btnSubmit.style.display = 'block';
            
            const btnVistaPrevio = document.getElementById('btn-vista-previa');
            btnVistaPrevio.style.display = 'block';

            // ========== OCULTAR LOADING Y MOSTRAR SELECT DE TIPO DE PEDIDO ==========
            const tipoPedidoLoading = document.getElementById('tipo-pedido-loading');
            const tipoPedidoSelect = document.getElementById('tipo_pedido_nuevo');
            
            if (tipoPedidoLoading && tipoPedidoSelect) {
                setTimeout(() => {
                    tipoPedidoLoading.style.display = 'none';
                    tipoPedidoSelect.style.display = 'block';
                    tipoPedidoSelect.removeAttribute('disabled');
                    console.log('‚úÖ Selector de tipo de pedido listo');
                }, 500);
            }

            // ========== DETECTAR TIPO INICIAL DESDE RUTA ==========
            const tipoInicial = '{{ $tipoInicial ?? "cotizacion" }}';
            
            // ========== MANEJAR CAMBIO DE TIPO DE PEDIDO ==========
            const tipoDesdeRadio = document.getElementById('tipo_desde_cotizacion');
            const tipoNuevoRadio = document.getElementById('tipo_nuevo_pedido');
            const tipoHidden = document.getElementById('tipo_pedido_hidden');
            const seccionBuscarCotizacion = document.getElementById('seccion-buscar-cotizacion');
            const seccionTipoPedidoNuevo = document.getElementById('seccion-tipo-pedido-nuevo');
            const selectTipoPedidoNuevo = document.getElementById('tipo_pedido_nuevo');
            const campNumeroCotizacion = document.getElementById('campo-numero-cotizacion');

            function actualizarVistaPedido() {
                // Si hay tipo inicial forzado, usar ese
                let tipoActual = tipoInicial;
                
                // Si no hay tipo inicial, usar los radio buttons
                if (!tipoHidden && tipoDesdeRadio && tipoNuevoRadio) {
                    tipoActual = tipoDesdeRadio.checked ? 'cotizacion' : 'nuevo';
                }
                
                if (tipoActual === 'cotizacion') {
                    // Mostrar buscador de cotizaci√≥n
                    if (seccionBuscarCotizacion) seccionBuscarCotizacion.style.display = 'block';
                    if (seccionTipoPedidoNuevo) seccionTipoPedidoNuevo.style.display = 'none';
                    if (campNumeroCotizacion) campNumeroCotizacion.style.display = 'block';
                } else if (tipoActual === 'nuevo') {
                    // Mostrar selector de tipo de pedido nuevo
                    if (seccionBuscarCotizacion) seccionBuscarCotizacion.style.display = 'none';
                    if (seccionTipoPedidoNuevo) seccionTipoPedidoNuevo.style.display = 'block';
                    if (campNumeroCotizacion) campNumeroCotizacion.style.display = 'none';
                }
            }

            // Ejecutar al cargar para configurar vista inicial
            actualizarVistaPedido();

            // Listener para cambios en radio buttons (solo si existen)
            if (tipoDesdeRadio) tipoDesdeRadio.addEventListener('change', actualizarVistaPedido);
            if (tipoNuevoRadio) tipoNuevoRadio.addEventListener('change', actualizarVistaPedido);

            // ========== GESTI√ìN DE √çTEMS DIN√ÅMICOS ==========
            // ‚ö†Ô∏è REFACTORIZADO: El c√≥digo de gesti√≥n de √≠tems ahora est√° en gestion-items-pedido.js
            // Solo mantenemos las referencias al DOM que se necesitan aqu√≠
            const seccionItems = document.getElementById('seccion-items-pedido');
            const btnAgregarItemCotizacion = document.getElementById('btn-agregar-item-cotizacion');
            const btnAgregarItemTipo = document.getElementById('btn-agregar-item-tipo');
            
            // Guardar cotizaci√≥n seleccionada globalmente
            window.cotizacionSeleccionadaActual = null;
            
            // Actualizar referencia cuando se selecciona una cotizaci√≥n
            const originalSeleccionarCotizacion = seleccionarCotizacion;
            seleccionarCotizacion = function(cotizacion) {
                window.cotizacionSeleccionadaActual = cotizacion;
                originalSeleccionarCotizacion(cotizacion);
            };
            
            // Agregar evento al bot√≥n "Agregar Prendas"
            if (btnAgregarItemCotizacion) {
                btnAgregarItemCotizacion.addEventListener('click', function() {
                    if (window.cotizacionSeleccionadaActual) {
                        window.abrirModalSeleccionPrendas(window.cotizacionSeleccionadaActual);
                    } else {
                        alert('Por favor selecciona una cotizaci√≥n primero');
                    }
                });
            }
            
            // ‚ö†Ô∏è itemsPedido ahora es window.itemsPedido (definido en gestion-items-pedido.js)

            // Mostrar secci√≥n de √≠tems seg√∫n el tipo
            function mostrarSeccionItems() {
                if (seccionItems) {
                    seccionItems.style.display = 'block';
                    
                    // Mostrar botones seg√∫n el tipo
                    const btnAgregarItemTipoInline = document.getElementById('btn-agregar-item-tipo-inline');
                    if (tipoInicial === 'cotizacion') {
                        btnAgregarItemCotizacion.style.display = 'flex';
                        btnAgregarItemTipo.style.display = 'none';
                        if (btnAgregarItemTipoInline) btnAgregarItemTipoInline.style.display = 'none';
                    } else if (tipoInicial === 'nuevo') {
                        btnAgregarItemCotizacion.style.display = 'none';
                        btnAgregarItemTipo.style.display = 'flex';
                        if (btnAgregarItemTipoInline) btnAgregarItemTipoInline.style.display = 'flex';
                    }
                    
                    window.actualizarVistaItems(); // ‚ö†Ô∏è Ahora es funci√≥n global del m√≥dulo
                }
            }

            // ‚ö†Ô∏è REFACTORIZADO: Las siguientes funciones ahora est√°n en gestion-items-pedido.js
            // - window.actualizarVistaItems()
            // - renderizarItems()
            // - determinarCategoria()
            // - obtenerColorCategoria()
            // - window.eliminarItem()
            // - window.obtenerItemsPedido()
            // - window.tieneItems()

            /* ============================================================
               C√ìDIGO COMENTADO - AHORA EN gestion-items-pedido.js
               ============================================================
               Las siguientes funciones fueron movidas al m√≥dulo:
               - actualizarVistaItems()
               - renderizarItems()
               - determinarCategoria()
               - obtenerColorCategoria()
               - eliminarItem()
               - obtenerItemsPedido()
               - tieneItems()
               ============================================================ */

            // ‚ö†Ô∏è COMENTADO: Los botones de agregar √≠tems de la secci√≥n 3 fueron removidos
            // La funcionalidad ahora est√° en el bot√≥n inline de la secci√≥n 2 (btn-agregar-item-tipo-inline)
            
            /* C√ìDIGO REMOVIDO:
            // Agregar √≠tem desde cotizaci√≥n
            btnAgregarItemCotizacion.addEventListener('click', function() {
                // Mostrar el buscador de cotizaci√≥n si est√° oculto
                if (seccionBuscarCotizacion.style.display === 'none') {
                    seccionBuscarCotizacion.style.display = 'block';
                }
                // Focus en el input de b√∫squeda
                document.getElementById('cotizacion_search_editable').focus();
            });

            // Agregar √≠tem de tipo nuevo
            btnAgregarItemTipo.addEventListener('click', function() {
                const tipoPedido = selectTipoPedidoNuevo.value;
                
                if (!tipoPedido) {
                    alert('Por favor selecciona un tipo de pedido primero');
                    return;
                }
                
                console.log('üéØ Abriendo modal para tipo:', tipoPedido);
                
                // Manejar diferentes tipos de pedido
                if (tipoPedido === 'P') {
                    window.abrirModalPrendaNueva();
                } else if (tipoPedido === 'R') {
                    window.abrirModalReflectivo();
                } else {
                    alert('Tipo de pedido "' + tipoPedido + '" en desarrollo');
                }
            });
            */

            // Agregar √≠tem de tipo nuevo desde el bot√≥n inline
            const btnAgregarItemTipoInline = document.getElementById('btn-agregar-item-tipo-inline');
            if (btnAgregarItemTipoInline) {
                btnAgregarItemTipoInline.addEventListener('click', function() {
                    const tipoPedido = selectTipoPedidoNuevo.value;
                    
                    if (!tipoPedido) {
                        alert('Por favor selecciona un tipo de pedido primero');
                        return;
                    }
                    
                    console.log('üéØ Abriendo modal para tipo:', tipoPedido);
                    
                    // Manejar diferentes tipos de pedido
                    if (tipoPedido === 'P') {
                        window.abrirModalPrendaNueva();
                    } else if (tipoPedido === 'R') {
                        window.abrirModalReflectivo();
                    } else {
                        alert('Tipo de pedido "' + tipoPedido + '" en desarrollo');
                    }
                });
            }

            // Funci√≥n para agregar cotizaci√≥n a la lista
            window.agregarCotizacionAItems = function(cotizacion) {
                const item = {
                    tipo: 'cotizacion',
                    id: cotizacion.id,
                    numero: cotizacion.numero_cotizacion,
                    cliente: cotizacion.cliente,
                    data: cotizacion
                };
                itemsPedido.push(item);
                actualizarVistaItems();
            };

            // Funci√≥n para agregar tipo nuevo a la lista
            window.agregarTipoAItems = function(tipo, nombre) {
                const item = {
                    tipo: 'nuevo',
                    tipoId: tipo,
                    nombre: nombre
                };
                itemsPedido.push(item);
                actualizarVistaItems();
            };

            // Manejar cambio de tipo de pedido nuevo
            window.manejarCambiaTipoPedido = function() {
                const tipoPedido = selectTipoPedidoNuevo.value;
                
                if (!tipoPedido) return;
                
                console.log('üîÑ Tipo de pedido seleccionado:', tipoPedido);
                
                // Mostrar bot√≥n de agregar tipo
                const btnAgregarTipo = document.getElementById('btn-agregar-item-tipo');
                if (btnAgregarTipo) {
                    btnAgregarTipo.style.display = 'flex';
                }
                
                // Mostrar bot√≥n inline
                const btnAgregarTipoInline = document.getElementById('btn-agregar-item-tipo-inline');
                if (btnAgregarTipoInline) {
                    btnAgregarTipoInline.style.display = 'flex';
                }
            };
            
            // Funci√≥n para abrir selector de archivos
            window.abrirSelectorPrendas = function() {
                const inputFotos = document.getElementById('nueva-prenda-foto-input');
                if (inputFotos) {
                    inputFotos.click();
                }
            };
            
            // ========== MODAL DE PRENDA NUEVA ==========
            // ‚ö†Ô∏è window.abrirModalPrendaNueva() MOVIDA AL COMPONENTE
            // Ubicaci√≥n: public/js/componentes/prendas.js
            
            // ========== GESTI√ìN DE M√öLTIPLES TELAS ==========
            // Las funciones de telas se han extra√≠do al m√≥dulo gestion-telas.js
            // - agregarTelaNueva()
            // - actualizarTablaTelas()
            // - eliminarTela(index)
            // - manejarImagenTela(input)
            // - mostrarPreviewImagenTela(dataUrl)
            // Consultar: public/js/modulos/crear-pedido/gestion-telas.js
            
                
            
            // ‚ö†Ô∏è limpiarFormularioPrendaNueva() MOVIDA AL COMPONENTE
            // Ubicaci√≥n: public/js/componentes/prendas.js
            // ‚ö†Ô∏è REFLECTIVO COMPONENT LOADED
            // Todas las funciones de reflectivo han sido movidas a: public/js/componentes/reflectivo.js
            // Las funciones globales son accesibles desde window:
            // - window.datosReflectivo
            // - window.abrirModalReflectivo()
            // - window.cerrarModalReflectivo()
            // - window.manejarImagenReflectivo()
            // - window.agregarUbicacionReflectivo()
            // - window.guardarConfiguracionReflectivo()
            // - window.mostrarResumenReflectivo()
            // Y muchas m√°s... Ver public/js/componentes/reflectivo.js para la lista completa
            // Ubicaci√≥n: public/js/componentes/prendas.js
            
            // Funci√≥n global para manejar cambio de variaciones (para inline onchange)
            window.manejarCheckVariacion = function(checkbox) {
                const idCheckbox = checkbox.id;
                let inputIds = [];
                
                if (idCheckbox === 'aplica-manga') inputIds = ['manga-input', 'manga-obs'];
                else if (idCheckbox === 'aplica-bolsillos') inputIds = ['bolsillos-input'];
                else if (idCheckbox === 'aplica-broche') inputIds = ['broche-input', 'broche-obs'];
                
                inputIds.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.disabled = !checkbox.checked;
                        input.style.opacity = checkbox.checked ? '1' : '0.5';
                    }
                });
            };
            
            // ‚ö†Ô∏è window.cerrarModalPrendaNueva() MOVIDA AL COMPONENTE
            // Ubicaci√≥n: public/js/componentes/prendas.js
            
            // ‚ö†Ô∏è window.agregarPrendaNueva() MOVIDA AL COMPONENTE
            // Ubicaci√≥n: public/js/componentes/prendas.js

            // ========== MODAL DE REFLECTIVO (ANTIGUO - ELIMINADO) ==========
            // El nuevo modal de reflectivo est√° definido arriba en abrirModalReflectivo()
            
            function configurarEventosReflectivo() {
                // No necesita configurar eventos adicionales
                // Los eventos onchange ya est√°n en los inputs din√°micos
            }
            
            function actualizarTotalReflectivo() {
                let total = 0;
                document.querySelectorAll('#reflectivo-tallas-container input[type="number"]').forEach(input => {
                    total += parseInt(input.value) || 0;
                });
                document.getElementById('total-reflectivo').textContent = total;
            }
            
            // cerrarModalReflectivo ya est√° definida arriba - no duplicar
            
            window.agregarReflectivo = function() {
                const nombre = document.getElementById('reflectivo-prenda-nombre').value.trim().toUpperCase();
                const observaciones = document.getElementById('reflectivo-observaciones').value.trim();
                const origen = document.getElementById('reflectivo-origen-select').value;
                
                if (!nombre) {
                    alert('Por favor ingresa el nombre de la prenda');
                    return;
                }
                
                // Obtener tallas y cantidades
                const tallas = [];
                let cantidadTotal = 0;
                document.querySelectorAll('#reflectivo-tallas-container input[type="number"]').forEach(input => {
                    const cantidad = parseInt(input.value) || 0;
                    if (cantidad > 0) {
                        const talla = input.name.replace('reflectivo-talla-', '').toUpperCase();
                        tallas.push({ talla, cantidad });
                        cantidadTotal += cantidad;
                    }
                });
                
                if (cantidadTotal === 0) {
                    alert('Por favor ingresa al menos una cantidad en las tallas');
                    return;
                }
                
                // Obtener ubicaciones del reflectivo
                const ubicaciones = [];
                document.querySelectorAll('input[name="reflectivo-ubicacion"]:checked').forEach(cb => {
                    ubicaciones.push(cb.value);
                });
                
                console.log('‚ûï Agregando reflectivo:', { nombre, cantidadTotal, origen, ubicaciones, observaciones });
                
                // Estructura del reflectivo
                const reflectivoData = {
                    nombre: nombre,
                    cantidad: cantidadTotal,
                    tallas: tallas,
                    ubicaciones: ubicaciones,
                    observaciones: observaciones,
                    imagenes: window.imagenesReflectivoStorage.obtenerImagenes()  // Guardar im√°genes
                };
                
                // REFLECTIVO SIEMPRE TIENE PROCESO
                // √çTEM 1: Prenda BASE (sin procesos)
                window.itemsPedido.push({
                    tipo: 'nuevo',
                    prenda: reflectivoData,
                    origen: origen,
                    procesos: [],
                    es_proceso: false,
                    tallas: tallas,
                    imagenes: window.imagenesReflectivoStorage.obtenerImagenes()  // Pasar im√°genes al nivel del √≠tem
                });
                
                // √çTEM 2: REFLECTIVO (con proceso reflectivo)
                window.itemsPedido.push({
                    tipo: 'nuevo',
                    prenda: reflectivoData,
                    origen: origen,
                    procesos: ['Reflectivo'],
                    es_proceso: true,
                    tallas: tallas,
                    imagenes: window.imagenesReflectivoStorage.obtenerImagenes()  // Pasar im√°genes al nivel del √≠tem
                });
                
                console.log(`‚úÖ Reflectivo "${nombre}" agregado como 2 √≠tems (BASE + REFLECTIVO)`);
                
                // Actualizar vista
                window.actualizarVistaItems();
                
                // Cerrar modal
                window.cerrarModalReflectivo();
            };

            // ========== TALLAS Y CANTIDADES ==========
            // Todas las funciones de gesti√≥n de tallas est√°n en gestion-tallas.js
            // Esto incluye: abrirModalSeleccionarTallas, cerrarModalTallas, crearTarjetaGenero, 
            // guardarCantidadTalla, actualizarTotalPrendas, obtenerTallasYCantidades, validarTallasSeleccionadas, etc.
            
            // NOTA: Las variables window.tallasSeleccionadas y window.cantidadesTallas 
            // se inicializan en gestion-tallas.js
            
            // Funci√≥n para actualizar tallas de REFLECTIVO
            window.actualizarTallasReflectivo = function() {
                const tipoTalla = document.getElementById('reflectivo-tipo-talla').value;
                const generoSelect = document.getElementById('reflectivo-genero-talla');
                const container = document.getElementById('reflectivo-tallas-container');
                
                // Mostrar/ocultar selector de g√©nero
                if (tipoTalla === 'numero') {
                    generoSelect.style.display = 'block';
                } else {
                    generoSelect.style.display = 'none';
                    generoSelect.value = '';
                }
                
                // Generar tallas
                let tallas = [];
                if (tipoTalla === 'letra') {
                    tallas = TALLAS_LETRAS;
                } else if (tipoTalla === 'numero') {
                    const genero = generoSelect.value;
                    if (genero === 'dama') {
                        tallas = TALLAS_NUMEROS_DAMA;
                    } else if (genero === 'caballero') {
                        tallas = TALLAS_NUMEROS_CABALLERO;
                    }
                }
                
                // Renderizar inputs de tallas
                container.innerHTML = '';
                tallas.forEach(talla => {
                    const div = document.createElement('div');
                    div.style.cssText = 'display: flex; flex-direction: column; gap: 0.25rem;';
                    div.innerHTML = `
                        <label style="font-size: 0.75rem; font-weight: 600; color: #92400e;">${talla}</label>
                        <input type="number" name="reflectivo-talla-${talla.toLowerCase()}" min="0" value="0" onchange="actualizarTotalReflectivo()" style="padding: 0.5rem; border: 2px solid #d1d5db; border-radius: 4px; text-align: center; font-weight: 600;">
                    `;
                    container.appendChild(div);
                });
                
                actualizarTotalReflectivo();
            };

            // ========== OCULTAR LOADING SCREEN ==========
            setTimeout(() => {
                const loadingOverlay = document.getElementById('page-loading-overlay');
                if (loadingOverlay) {
                    loadingOverlay.classList.add('fade-out');
                    setTimeout(() => {
                        loadingOverlay.style.display = 'none';
                    }, 300);
                }
            }, 500);
        });
    </script>
@endpush