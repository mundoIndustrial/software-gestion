<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba - Protecci√≥n de Im√°genes de Cotizaci√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Rounded" rel="stylesheet">
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">üß™ Prueba de Protecci√≥n de Im√°genes de Cotizaci√≥n</h1>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">üìã Escenario de Prueba</h2>
            <div class="space-y-3 text-gray-700">
                <p><strong>Objetivo:</strong> Verificar que las im√°genes de una cotizaci√≥n original permanecen intactas al editar un pedido.</p>
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                    <p class="font-medium">Flujo a probar:</p>
                    <ol class="list-decimal list-inside mt-2 space-y-1">
                        <li>Crear una prenda desde cotizaci√≥n (con im√°genes)</li>
                        <li>Abrir galer√≠a de im√°genes</li>
                        <li>Verificar indicador de protecci√≥n</li>
                        <li>Eliminar una imagen</li>
                        <li>Confirmar mensaje de advertencia</li>
                        <li>Guardar el pedido</li>
                        <li>Verificar que la cotizaci√≥n original no fue afectada</li>
                    </ol>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">üîß Controles de Prueba</h2>
            <div class="space-y-4">
                <button onclick="simularPrendaDeCotizacion()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                    üì¶ Simular Prenda de Cotizaci√≥n
                </button>
                <button onclick="abrirGaleriaProtegida()" class="bg-amber-600 text-white px-4 py-2 rounded hover:bg-amber-700 transition">
                    üñºÔ∏è Abrir Galer√≠a Protegida
                </button>
                <button onclick="simularEliminacion()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">
                    üóëÔ∏è Simular Eliminaci√≥n
                </button>
                <button onclick="verificarEstado()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                    ‚úÖ Verificar Estado
                </button>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">üìä Resultados de la Prueba</h2>
            <div id="resultados" class="space-y-2 text-gray-700">
                <p class="text-gray-500">Los resultados de la prueba aparecer√°n aqu√≠...</p>
            </div>
        </div>
    </div>

    <script>
        // Simular datos de prenda de cotizaci√≥n
        let prendaDePrueba = null;

        function simularPrendaDeCotizacion() {
            prendaDePrueba = {
                id: 1,
                nombre_prenda: 'Camisa de Prueba',
                cotizacion_id: 123,
                tipo: 'cotizacion',
                imagenes: [
                    { ruta: '/storage/test/imagen1.jpg', uid: 'img1' },
                    { ruta: '/storage/test/imagen2.jpg', uid: 'img2' },
                    { ruta: '/storage/test/imagen3.jpg', uid: 'img3' }
                ]
            };

            // Asignar al gestor global
            window.prendaActual = prendaDePrueba;
            window.gestionItemsUI = {
                prendaEditIndex: 0,
                obtenerItemsOrdenados: () => [prendaDePrueba]
            };

            actualizarResultados('‚úÖ Prenda de cotizaci√≥n simulada', 'success');
            console.log('Prenda de cotizaci√≥n simulada:', prendaDePrueba);
        }

        function abrirGaleriaProtegida() {
            if (!prendaDePrueba) {
                actualizarResultados('‚ùå Primero simula una prenda de cotizaci√≥n', 'error');
                return;
            }

            // Simular apertura de galer√≠a
            const esPrendaDeCotizacion = !!(prendaDePrueba.cotizacion_id || prendaDePrueba.tipo === 'cotizacion');
            
            actualizarResultados(`üñºÔ∏è Galer√≠a abierta - ¬øEs de cotizaci√≥n? ${esPrendaDeCotizacion ? 'S√ç' : 'NO'}`, 'info');
            
            // Mostrar caracter√≠sticas de protecci√≥n
            const caracteristicas = [
                'üîí Bot√≥n de eliminar color √°mbar (no rojo)',
                'üõ°Ô∏è Indicador visual de protecci√≥n',
                '‚ö†Ô∏è Mensaje de confirmaci√≥n personalizado',
                'üìù Imagen marcada para eliminaci√≥n (no eliminada directamente)'
            ];
            
            caracteristicas.forEach(car => {
                actualizarResultados(car, 'info');
            });
        }

        function simularEliminacion() {
            if (!prendaDePrueba) {
                actualizarResultados('‚ùå Primero simula una prenda de cotizaci√≥n', 'error');
                return;
            }

            // Simular eliminaci√≥n de la imagen 1
            const indiceEliminar = 1;
            const imagenEliminada = prendaDePrueba.imagenes[indiceEliminar];
            
            // Marcar como eliminada del pedido (protecci√≥n)
            if (!prendaDePrueba.imagenesEliminadasDelPedido) {
                prendaDePrueba.imagenesEliminadasDelPedido = [];
            }
            
            prendaDePrueba.imagenesEliminadasDelPedido.push({
                ...imagenEliminada,
                indiceOriginal: indiceEliminar,
                timestamp: Date.now()
            });

            actualizarResultades(`üóëÔ∏è Imagen ${indiceEliminar + 1} marcada para eliminaci√≥n del pedido`, 'warning');
            actualizarResultados('üîí Cotizaci√≥n original protegida - imagen NO eliminada de la cotizaci√≥n', 'success');
        }

        function verificarEstado() {
            if (!prendaDePrueba) {
                actualizarResultados('‚ùå Primero simula una prenda de cotizaci√≥n', 'error');
                return;
            }

            const resultados = [
                `üì¶ Prenda: ${prendaDePrueba.nombre_prenda}`,
                `üÜî Cotizaci√≥n ID: ${prendaDePrueba.cotizacion_id}`,
                `üñºÔ∏è Im√°genes totales: ${prendaDePrueba.imagenes.length}`,
                `üóëÔ∏è Im√°genes marcadas para eliminaci√≥n: ${prendaDePrueba.imagenesEliminadasDelPedido?.length || 0}`,
                `‚úÖ Cotizaci√≥n original intacta: ${prendaDePrueba.imagenes.length === 3 ? 'S√ç' : 'NO'}`
            ];

            resultados.forEach(resultado => {
                actualizarResultados(resultado, 'info');
            });

            // Verificaci√≥n final
            const imagenesOriginales = prendaDePrueba.imagenes.length;
            const imagenesMarcadas = prendaDePrueba.imagenesEliminadasDelPedido?.length || 0;
            const proteccionFunciona = imagenesOriginales === 3 && imagenesMarcadas > 0;

            if (proteccionFunciona) {
                actualizarResultados('üéâ PRUEBA EXITOSA: La protecci√≥n de im√°genes funciona correctamente', 'success');
            } else {
                actualizarResultados('‚ö†Ô∏è Revisar implementaci√≥n - la protecci√≥n podr√≠a no estar funcionando', 'warning');
            }
        }

        function actualizarResultados(mensaje, tipo = 'info') {
            const resultadosDiv = document.getElementById('resultados');
            const timestamp = new Date().toLocaleTimeString();
            
            const colores = {
                success: 'text-green-600',
                error: 'text-red-600',
                warning: 'text-amber-600',
                info: 'text-blue-600'
            };

            const resultado = document.createElement('div');
            resultado.className = `${colores[tipo]} p-2 border-l-4 border-${tipo === 'success' ? 'green' : tipo === 'error' ? 'red' : tipo === 'warning' ? 'amber' : 'blue'}-400 bg-gray-50`;
            resultado.innerHTML = `<span class="font-mono text-xs">[${timestamp}]</span> ${mensaje}`;
            
            resultadosDiv.appendChild(resultado);
            resultadosDiv.scrollTop = resultadosDiv.scrollHeight;
        }

        // Inicializaci√≥n
        actualizarResultados('üß™ Sistema de prueba inicializado', 'success');
        actualizarResultados('üí° Usa los botones para simular el flujo de protecci√≥n de im√°genes', 'info');
    </script>
</body>
</html>
